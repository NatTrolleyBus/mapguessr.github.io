<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Map Guessr</title>
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptilersdk.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      color: #333;
    }
    
    header {
      background-color: #0cc0df;
      padding: 20px;
      border-radius: 0 0 5px 5px;
    }
    h1 {
      color: #444;
      margin-top: 0;
    }
    main {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    section {
      margin-bottom: 30px;
    }
    .maps-container {
      position: relative;
      height: 600px;
      width: 100%;
      margin-bottom: 20px;
    }
    #maptiler-map {
      position: relative;
      width: 100%;
      height: 100%;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
      background-color: #eaeaea;
    }
    #overlay-map {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 250px;
      height: 150px;
      border: 2px solid #555;
      border-radius: 5px;
      overflow: hidden;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 10;
      transition: all 0.3s ease-in-out;
    }
    #overlay-map:hover {
      width: 400px;
      height: 300px;
    }
    .submit-container {
      text-align: center;
      margin-bottom: 30px;
    }
    .submit-btn, .new-location-btn, .init-btn {
      background-color: #0cc0df;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 0 10px;
    }
    .submit-btn:hover, .new-location-btn:hover, .init-btn:hover {
      background-color: #0aa8c4;
    }
    .submit-btn:disabled, .new-location-btn:disabled, .init-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    /* Token authentication styles */
    .api-auth-section {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
    }
    .token-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .token-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
    }
    .token-status {
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    .token-status.valid {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .token-status.invalid {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .token-status.pending {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    footer {
      background-color: #0cc0df;
      padding: 10px;
      text-align: center;
      border-radius: 5px;
      font-size: 0.9em;
      margin-top: 40px;
    }
    
    /* CSS to hide default MapTiler controls */
    .maptiler-ctrl-group,
    .maptiler-ctrl,
    .maplibregl-ctrl-group,
    .maplibregl-ctrl {
      display: none !important;
    }

    /* Style for the custom guess pin */
    .guess-pin {
        position: absolute;
        width: 24px;
        height: 36px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%23e53e3e" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
        background-size: contain;
        background-repeat: no-repeat;
        transform: translate3d(-50%, -100%, 0);
        z-index: 11;
        cursor: pointer;
    }

  </style>
</head>
<body>
  <header>
    <h1>Test</h1>
    <p>May 15th 2025 - V10 (Token Authentication Support - Fixed)</p>
  </header>
  <main>
    <section>
      <h2>About</h2>
      <p>Game Rules: Enter your API token and click "Initialize Maps" to begin playing.</p>
      
      <div class="api-auth-section">
        <h3>API Configuration</h3>
        <div class="token-input-group">
          <label for="api-token">API Token:</label>
          <input type="text" id="api-token" class="token-input" placeholder="Enter your API token here" />
          <button class="init-btn" id="init-maps">Initialize Maps</button>
          <span id="token-status" class="token-status pending">Enter token</span>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          <strong>Required:</strong> You need a valid API token from the MapGuessr service to play.
        </p>
      </div>
    </section>
    <section>
      <h2>Maps</h2>
      <div class="maps-container">
        <div id="maptiler-map">
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
            <p>Enter API token and click "Initialize Maps" to load the game</p>
          </div>
        </div>
        <div id="overlay-map">
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 12px; text-align: center; padding: 10px;">
            <p>Maps will load after initialization</p>
          </div>
        </div>
      </div>
      <div class="submit-container">
        <button class="new-location-btn" id="new-location" disabled>New Location</button>
        <button class="submit-btn" id="submit-guess" disabled>Submit</button>
      </div>
    </section>
    <section>
      <h2>Game Answers</h2>
      <ul>
        <li id="location-text">Initialize maps to begin playing</li>
        <li id="guessed-coords">The guessed coordinates will appear here</li>
        <li id="submit-status">Game status will appear here</li>
        <li id="points-score">Points will be calculated here</li>
        <li id="round-count">Round: 1</li>
      </ul>
    </section>
  </main>
  <footer>
    <p>Made by Nathan</p>
  </footer>

  <script>
    // --- Configuration ---
    const MAPTILER_API_KEY = 'ZS9RHHRim7f1OZRKuI6n'; // Your original MapTiler API key for map loading
    
    // API configuration
    let API_BASE_URL = 'https://mapguessr-worker.games-6cb.workers.dev';
    let API_TOKEN = '';

    let currentMarker = null;
    let userGuessLngLat = null;
    let guessPinElement = null;
    let currentLocationCoords = null;
    let totalScore = 0;
    let mainMap = null;
    let overlayMap = null;
    let roundCount = 1;
    let mapsInitialized = false;

    const zoomLevel = 15;
    const initialCenter = [0, 0];
    const initialZoom = -1.0;

    // Fixed style URLs (removed spaces)
    const customStyleUrl = `https://api.maptiler.com/maps/0196cb69-f55f-71f8-9a8f-90fa083f0f67/style.json?key=${MAPTILER_API_KEY}`;
    const overlayStyleUrl = `https://api.maptiler.com/maps/0196cb7f-9914-7a9b-aed1-8bfa7b9a0705/style.json?key=${MAPTILER_API_KEY}`;

    // Configure MapTiler SDK
    maptilersdk.config.apiKey = MAPTILER_API_KEY;

    // --- Token Authentication Functions ---
    function updateTokenStatus(status, message) {
        const statusElement = document.getElementById('token-status');
        statusElement.className = `token-status ${status}`;
        statusElement.textContent = message;
    }

    function validateToken(token) {
        if (!token || token.trim() === '') {
            updateTokenStatus('invalid', 'Token required');
            return false;
        }
        
        if (token.length < 10) {
            updateTokenStatus('invalid', 'Token too short');
            return false;
        }
        
        updateTokenStatus('valid', 'Token valid');
        return true;
    }

    async function testTokenAuth() {
        if (!API_TOKEN) {
            updateTokenStatus('invalid', 'No token set');
            return false;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/cities?token=${API_TOKEN}`);
            
            if (response.ok) {
                updateTokenStatus('valid', 'Token verified');
                return true;
            } else if (response.status === 401 || response.status === 403) {
                updateTokenStatus('invalid', 'Invalid token');
                return false;
            } else {
                updateTokenStatus('invalid', 'API error');
                return false;
            }
        } catch (error) {
            updateTokenStatus('invalid', 'Connection error');
            return false;
        }
    }

    // --- Map Initialization ---
    async function initializeMaps() {
        const tokenInput = document.getElementById('api-token');
        const token = tokenInput.value.trim();
        
        if (!validateToken(token)) {
            return false;
        }
        
        API_TOKEN = token;
        
        // Test token authentication
        const authValid = await testTokenAuth();
        if (!authValid) {
            return false;
        }

        try {
            // Clear the placeholder content
            document.getElementById('maptiler-map').innerHTML = '';
            document.getElementById('overlay-map').innerHTML = '';

            // Initialize the main map
            mainMap = new maptilersdk.Map({
                container: 'maptiler-map',
                style: customStyleUrl,
                center: [0, 0],
                zoom: 1,
                interactive: false
            });

            // Initialize the overlay map
            overlayMap = new maptilersdk.Map({
                container: 'overlay-map',
                style: overlayStyleUrl,
                center: initialCenter,
                zoom: initialZoom,
                interactive: true
            });

            // Set up event listeners
            setupMapEventListeners();
            
            mapsInitialized = true;
            
            // Enable game buttons
            document.getElementById('new-location').disabled = false;
            document.getElementById('submit-guess').disabled = false;
            
            // Update status
            document.getElementById('location-text').textContent = 'Maps initialized! Click "New Location" to start playing.';
            
            return true;
            
        } catch (error) {
            console.error('Error initializing maps:', error);
            updateTokenStatus('invalid', 'Map init failed');
            return false;
        }
    }

    function setupMapEventListeners() {
        // Add error listeners
        mainMap.on('error', (e) => {
            console.error('Main map loading error:', e.error);
            document.getElementById('location-text').textContent = "Error loading main map. Check console.";
        });

        overlayMap.on('error', (e) => {
            console.error('Overlay map loading error:', e.error);
            document.getElementById('guessed-coords').textContent = "Error loading overlay map. Check console.";
        });

        // Style load handlers
        mainMap.on('style.load', () => {
            console.log('Main map style loaded.');
            try {
                mainMap.getContainer().querySelectorAll('.maptiler-ctrl, .maplibregl-ctrl').forEach(ctrl => ctrl.remove());
            } catch (e) {
                console.warn("Could not remove controls programmatically for main map:", e);
            }
        });

        overlayMap.on('style.load', () => {
            console.log('Overlay map style loaded.');
            try {
                overlayMap.getContainer().querySelectorAll('.maptiler-ctrl, .maplibregl-ctrl').forEach(ctrl => ctrl.remove());
            } catch (e) {
                console.warn("Could not remove controls programmatically for overlay map:", e);
            }
        });

        // Click handlers for overlay map
        overlayMap.on('click', (e) => {
            const clickedLngLat = e.lngLat;
            console.log('Overlay map left-clicked at:', clickedLngLat);
            placeCustomGuessPinOnOverlay(clickedLngLat);
        });

        overlayMap.on('contextmenu', (e) => {
            e.preventDefault();
            const clickedLngLat = e.lngLat;
            console.log('Overlay map right-clicked at:', clickedLngLat);
            placeCustomGuessPinOnOverlay(clickedLngLat);
        });

        // Resize handler
        const overlayMapElement = document.getElementById('overlay-map');
        overlayMapElement.addEventListener('transitionend', () => {
            console.log('Overlay map container transition ended. Resizing map.');
            if (overlayMap) {
                overlayMap.resize();
                setTimeout(() => {
                    updateGuessPinPosition();
                }, 50);
            }
        });
    }

    // --- Game Functions ---
    function getRandomCoordinateInBounds(bounds) {
        const minLng = bounds[0];
        const minLat = bounds[1];
        const maxLng = bounds[2];
        const maxLat = bounds[3];

        const buffer = 0.001;
        const bufferedMinLng = minLng + (maxLng - minLng) * buffer;
        const bufferedMinLat = minLat + (maxLat - minLat) * buffer;
        const bufferedMaxLng = maxLng - (maxLng - minLng) * buffer;
        const bufferedMaxLat = maxLat - (maxLat - minLat) * buffer;

        const randomLng = bufferedMinLng + (bufferedMaxLng - bufferedMinLng) * Math.random();
        const randomLat = bufferedMinLat + (bufferedMaxLat - bufferedMinLat) * Math.random();

        return [randomLng, randomLat];
    }

    function addOrUpdateMarker(lngLatInput) {
        const lngLatObject = Array.isArray(lngLatInput) ?
                           new maptilersdk.LngLat(lngLatInput[0], lngLatInput[1]) :
                           lngLatInput;

         if (!(lngLatObject instanceof maptilersdk.LngLat) || typeof lngLatObject.lng !== 'number' || typeof lngLatObject.lat !== 'number') {
              console.error("addOrUpdateMarker received invalid LngLat data:", lngLatInput);
              return;
         }

        if (currentMarker) {
            currentMarker.remove();
        }
        currentMarker = new maptilersdk.Marker()
            .setLngLat(lngLatObject)
            .addTo(mainMap);

        currentLocationCoords = lngLatObject;

         if (currentMarker && currentMarker.getElement()) {
            currentMarker.getElement().style.display = 'none';
        }
         console.log("currentLocationCoords set to LngLat object:", currentLocationCoords);
    }

    function calculateDistanceInMeters(lat1, lon1, lat2, lon2) {
        if (typeof lat1 !== 'number' || typeof lon1 !== 'number' || typeof lat2 !== 'number' || typeof lon2 !== 'number') {
            console.error("Invalid input types for calculateDistanceInMeters:", lat1, lon1, lat2, lon2);
            return NaN;
        }

        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;

        const a =
            Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);

        const c = 2 * Math.atan2(Math.sqrt(Math.max(0, a)), Math.sqrt(Math.max(0, 1 - a)));

        const distance = R * c;
        return distance;
    }

    function calculateGeoGuessrScore(lat1, lon1, lat2, lon2) {
        const MAX_SCORE = 5000;
        const FIVE_K_THRESHOLD_METERS = 100;

        const distance = calculateDistanceInMeters(lat1, lon1, lat2, lon2);

         if (isNaN(distance)) {
            console.error("Distance calculation returned NaN.");
            return { distance: NaN, score: NaN };
        }

        let score;

        if (distance <= FIVE_K_THRESHOLD_METERS) {
            score = MAX_SCORE;
        } else {
            const decayFactor = 2000000;
            score = MAX_SCORE * Math.exp(-distance / decayFactor);
            score = Math.max(0, Math.round(score));
        }

        return {
            distance: distance,
            score: score
        };
    }

    function updateGuessPinPosition() {
        if (!overlayMap || !userGuessLngLat || !guessPinElement) {
            return;
        }

         if (!(userGuessLngLat instanceof maptilersdk.LngLat) || typeof userGuessLngLat.lng !== 'number' || typeof userGuessLngLat.lat !== 'number') {
             console.error("Invalid userGuessLngLat object for positioning:", userGuessLngLat);
             return;
        }

        const pixelCoords = overlayMap.project(userGuessLngLat);

        guessPinElement.style.left = `${pixelCoords.x}px`;
        guessPinElement.style.top = `${pixelCoords.y}px`;
    }

    function placeCustomGuessPinOnOverlay(lngLat) {
        console.log('Attempting to place custom guess pin at LngLat:', lngLat);

        userGuessLngLat = lngLat;

        if (guessPinElement) {
            console.log('Removing existing custom guess pin element.');
            guessPinElement.remove();
        }

        guessPinElement = document.createElement('div');
        guessPinElement.className = 'guess-pin';

        overlayMap.getCanvasContainer().appendChild(guessPinElement);

        console.log('New custom guess pin element created:', guessPinElement);

        updateGuessPinPosition();

        document.getElementById('guessed-coords').textContent = `Guessed Location: Lng: ${lngLat.lng.toFixed(6)}, Lat: ${lngLat.lat.toFixed(6)}`;
        document.getElementById('submit-status').textContent = 'Guess placed. Click Submit!';

        overlayMap.off('move', updateGuessPinPosition);
        overlayMap.on('move', updateGuessPinPosition);

         console.log("Guess pin placed and move listener added. userGuessLngLat:", userGuessLngLat);
    }

    async function findRandomCityAndSpot(attempt = 1) {
        const locationText = document.getElementById('location-text');

        if (!API_TOKEN || !mapsInitialized) {
            locationText.textContent = 'Please initialize maps first.';
            return;
        }

        locationText.textContent = 'Finding a new location...';
        document.getElementById('guessed-coords').textContent = 'Make your guess on the overlay map...';
        document.getElementById('submit-status').textContent = 'Place your guess on the overlay map...';
        document.getElementById('points-score').textContent = 'Points: - | Total: ' + totalScore + ' points';

        if (currentMarker) {
            currentMarker.remove();
            currentMarker = null;
        }
         if (guessPinElement) {
            guessPinElement.remove();
            guessPinElement = null;
            userGuessLngLat = null;
            if(overlayMap) overlayMap.off('move', updateGuessPinPosition);
             console.log("Custom guess pin element and move listener removed.");
        }
         currentLocationCoords = null;

        const MAX_LOCATION_RETRIES = 10;
        if (attempt > MAX_LOCATION_RETRIES) {
            locationText.textContent = `Failed to find a valid city location after ${MAX_LOCATION_RETRIES} attempts.`;
            console.error(`Failed to find a valid city location after ${MAX_LOCATION_RETRIES} attempts.`);
            return;
        }

        console.log(`Attempting to find random city (Attempt ${attempt}/${MAX_LOCATION_RETRIES})...`);
        locationText.textContent = `Working on a random city (Attempt ${attempt})...`;

        try {
            // Fetch random city
            const cityApiUrl = `${API_BASE_URL}/api/cities?token=${API_TOKEN}`;
            const cityResponse = await fetch(cityApiUrl);
            
            if (!cityResponse.ok) {
                if (cityResponse.status === 401 || cityResponse.status === 403) {
                    updateTokenStatus('invalid', 'Invalid token');
                    locationText.textContent = 'Authentication failed. Please check your token.';
                    return;
                }
                throw new Error(`HTTP error fetching random city: ${cityResponse.status}`);
            }
            
            const cityData = await cityResponse.json();
            const cityName = cityData.city;

            if (!cityName) {
                console.warn(`Random City API returned no city name (Attempt ${attempt}). Retrying...`);
                findRandomCityAndSpot(attempt + 1);
                return;
            }

            console.log(`Successfully fetched city: ${cityName}. Finding geocoding data...`);
            locationText.textContent = `Finding a random spot in ${cityName}...`;

            // Get geocoding data
            const geocodingUrl = `${API_BASE_URL}/api/geocode?city=${encodeURIComponent(cityName)}&token=${API_TOKEN}`;
            const geocodingResponse = await fetch(geocodingUrl);
            
            if (!geocodingResponse.ok) {
                if (geocodingResponse.status === 401 || geocodingResponse.status === 403) {
                    updateTokenStatus('invalid', 'Invalid token');
                    locationText.textContent = 'Authentication failed. Please check your token.';
                    return;
                }
                console.warn(`HTTP error geocoding "${cityName}" (Attempt ${attempt}): ${geocodingResponse.status}. Retrying...`);
                findRandomCityAndSpot(attempt + 1);
                return;
            }
            
            const geocodingData = await geocodingResponse.json();

            if (geocodingData && geocodingData.features && geocodingData.features.length > 0) {
                const feature = geocodingData.features[0];
                const bounds = feature.bbox;
                const center = feature.center;

                let randomLngLatArray;

                if (bounds) {
                    randomLngLatArray = getRandomCoordinateInBounds(bounds);
                     console.log("Using bounds to find random coordinate array:", randomLngLatArray);
                } else if (center) {
                    const randomLng = center[0] + (Math.random() - 0.5) * 0.02;
                    const randomLat = center[1] + (Math.random() - 0.5) * 0.02;
                    randomLngLatArray = [randomLng, randomLat];
                     console.log("Using center with offset to find random coordinate array:", randomLngLatArray);
                } else {
                    console.warn(`Geocoding API could not find detailed location data for "${cityName}" (Attempt ${attempt}). Retrying...`);
                    findRandomCityAndSpot(attempt + 1);
                    return;
                }

                 console.log("Setting main map view to:", randomLngLatArray, "at zoom", zoomLevel);
                if (mainMap) {
                     mainMap.jumpTo({
                         center: randomLngLatArray,
                         zoom: zoomLevel,
                         essential: true
                     });
                } else {
                     console.error("mainMap not initialized when trying to jumpTo.");
                }

                document.getElementById('location-text').textContent = `Location: A random spot in ${feature.place_name || cityName}`;

                addOrUpdateMarker(randomLngLatArray);

                 console.log("New location setup complete via API. currentLocationCoords:", currentLocationCoords);

            } else {
                console.warn(`Geocoding API could not find the location for "${cityName}" (Attempt ${attempt}). Retrying...`);
                findRandomCityAndSpot(attempt + 1);
            }

        } catch (error) {
            console.error(`Error during API call (Attempt ${attempt}):`, error);
            locationText.textContent = `An error occurred fetching location: ${error.message}. Retrying...`;
            findRandomCityAndSpot(attempt + 1);
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize maps button
        document.getElementById('init-maps').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Initializing...';
            
            const success = await initializeMaps();
            
            if (success) {
                this.textContent = 'Maps Initialized';
                document.getElementById('api-token').disabled = true;
            } else {
                this.disabled = false;
                this.textContent = 'Initialize Maps';
            }
        });

        // Token input validation
        const tokenInput = document.getElementById('api-token');
        tokenInput.addEventListener('input', function() {
            const token = this.value.trim();
            if (token) {
                validateToken(token);
            } else {
                updateTokenStatus('pending', 'Enter token');
            }
        });

        // New Location button
        document.getElementById('new-location').addEventListener('click', function() {
            if (mapsInitialized && API_TOKEN) {
                findRandomCityAndSpot();
            }
        });

        // Submit button
        document.getElementById('submit-guess').addEventListener('click', function() {
            console.log("Submit button clicked.");
            
            if (!userGuessLngLat || !(userGuessLngLat instanceof maptilersdk.LngLat)) {
                document.getElementById('submit-status').textContent = 'Please make a guess by clicking on the map.';
                console.warn("Submit clicked without a valid guess location.");
                return;
            }

            if (!currentLocationCoords || !(currentLocationCoords instanceof maptilersdk.LngLat)) {
                document.getElementById('submit-status').textContent = 'Error: No location set for scoring.';
                 console.error('Error: Submit clicked but currentLocationCoords is null or not a LngLat object.');
                return;
            }

            const guessedLngLat = userGuessLngLat;
            const actualLngLat = currentLocationCoords;

            console.log("Actual LngLat for scoring:", actualLngLat);
            console.log("Guessed LngLat for scoring:", guessedLngLat);

             if (typeof actualLngLat.lat !== 'number' || typeof actualLngLat.lng !== 'number' || typeof guessedLngLat.lat !== 'number' || typeof guessedLngLat.lng !== 'number') {
                console.error("Score Calculation Error: One or more coordinate values are not numbers.", {actual: actualLngLat, guessed: guessedLngLat});
                document.getElementById('submit-status').textContent = 'Error: Cannot calculate score due to invalid coordinate data.';
                return;
            }

            const scoreResult = calculateGeoGuessrScore(
                actualLngLat.lat,
                actualLngLat.lng,
                guessedLngLat.lat,
                guessedLngLat.lng
            );

             console.log("Score Calculation Result:", scoreResult);
             if (isNaN(scoreResult.score) || isNaN(scoreResult.distance)) {
                  console.error("Score calculation returned NaN.", scoreResult);
                  document.getElementById('submit-status').textContent = 'Error: Score calculation failed.';
                  return;
             }

            totalScore += scoreResult.score;

            document.getElementById('points-score').textContent =
                `Round Score: ${scoreResult.score} points (${(scoreResult.distance/1000).toFixed(2)} km) | Total Score: ${totalScore} points`;

            document.getElementById('submit-status').textContent = `Guess submitted! You were ${(scoreResult.distance/1000).toFixed(2)} km away.`;

            if (currentMarker && currentMarker.getElement()) {
                 currentMarker.getElement().style.display = 'block';
                 console.log("Showing actual location marker on main map.");
            } else {
                 console.warn("Could not find currentMarker element to show.");
            }

            roundCount++;
            document.getElementById('round-count').textContent = `Round: ${roundCount}`;

            setTimeout(() => {
                console.log("Starting next round...");
                findRandomCityAndSpot();
            }, 5000);
        });
    });
  </script>
</body>
</html>
