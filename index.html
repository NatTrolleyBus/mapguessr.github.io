<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Map Guessr</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptilersdk.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #0cc0df;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        header div {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        h1 {
            color: #444;
            margin-top: 0;
            margin-right: 20px; /* Space between title and buttons */
        }
        main {
            padding: 20px;
            max-width: 1900px;
            margin: 0 auto;
        }
        section {
            margin-bottom: 30px;
        }
        .maps-container {
            position: relative;
            height: 900px; /* Fixed height for the container */
            width: 100%;
            margin-bottom: 20px;
            overflow: hidden;
        }
        #maptiler-map {
            position: relative;
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            background-color: #eaeaea;
        }
        #overlay-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 150px;
            border: 2px solid #555;
            border-radius: 5px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: all 0.4s ease-in-out;
        }
        #overlay-map:hover:not(.overlay-map-fullscreen) {
            width: 400px;
            height: 300px;
        }
        .overlay-map-fullscreen {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important; /* Fill the entire maps-container */
            z-index: 100 !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important; /* Remove shadow when fullscreen */
        }
        .submit-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .submit-btn, .new-location-btn, .auth-btn, .init-btn, .refresh-leaderboard-btn {
            background-color: #0cc0df;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        .submit-btn:hover, .new-location-btn:hover, .auth-btn:hover, .init-btn:hover, .refresh-leaderboard-btn:hover {
            background-color: #0aa8c4;
        }
        .submit-btn:disabled, .new-location-btn:disabled, .init-btn:disabled, .refresh-leaderboard-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .auth-btn {
            padding: 8px 15px;
            font-size: 1em;
            margin-left: 10px;
            background-color: #007bff; /* Default for login/account */
        }
        #register-btn {
            background-color: #28a745;
        }
        #logout-btn {
            background-color: #dc3545;
        }
        #my-account-btn {
            background-color: #6c757d; /* Grey for account button */
        }
        footer {
            background-color: #0cc0df;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 40px;
        }
        .maptiler-ctrl-group,
        .maptiler-ctrl,
        .maplibregl-ctrl-group,
        .maplibregl-ctrl {
            display: none !important;
        }
        .guess-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%23e53e3e" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform: translate3d(-50%, -100%, 0);
            z-index: 101;
            pointer-events: none;
        }
        .real-location-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%2328a745" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform: translate3d(-50%, -100%, 0);
            z-index: 102;
            pointer-events: none;
        }
        #next-round-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 30px;
            font-size: 1.1em;
            background-color: #0cc0df;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 110; /* Ensure it's above the maps */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }
        #next-round-btn:hover {
            background-color: #0aa8c4;
        }
        #round-score-display, #total-score-display {
            position: fixed; /* Fixed position relative to viewport */
            padding: 10px 15px;
            background-color: black; /* Changed to solid black */
            color: white;
            font-size: 1.2em;
            border-radius: 5px;
            z-index: 1000; /* High z-index to be on top */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            border: 1px solid white; /* Added white border */
        }
        #round-score-display {
            bottom: 20px;
            left: 20px;
        }
        #total-score-display {
            bottom: 20px;
            right: 20px;
        }
        #account-page {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: none; /* Hidden by default */
        }
        #account-page h2 {
            color: #0cc0df;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        #account-page p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        #account-page strong {
            color: #555;
        }

        /* Token authentication styles */
        .api-auth-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .token-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .token-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        .token-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .token-status.valid {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .token-status.invalid {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .token-status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Leaderboard styles */
        .leaderboard-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .leaderboard-table th {
            background-color: #0cc0df;
            color: white;
            font-weight: bold;
        }
        .leaderboard-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .leaderboard-table tr:hover {
            background-color: #e9ecef;
        }
        .rank-1 { font-weight: bold; color: #ffd700; }
        .rank-2 { font-weight: bold; color: #c0c0c0; }
        .rank-3 { font-weight: bold; color: #cd7f32; }
        .leaderboard-status {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        .score-post-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Map Guessr</h1>
            <p>May 15th 2025 - V9 (Score Calculation Fix)</p>
        </div>
        <div id="auth-container">
            <button id="login-btn" class="auth-btn">Login</button>
            <button id="register-btn" class="auth-btn">Register</button>
            <button id="my-account-btn" class="auth-btn" style="display:none;">My Account</button>
            <button id="logout-btn" class="auth-btn" style="display:none;">Logout</button>
            <span id="user-info" style="margin-left: 20px; color: #fff;"></span>
        </div>
    </header>
    <main style="display:none;">
        <section id="game-section">
            <h2>About</h2>
            <p>Game Rules: Enter your API token to load maps and begin playing. All map data and styles are loaded through the authenticated API.</p>

            <div class="api-auth-section">
                <h3>API Configuration</h3>
                <div class="token-input-group">
                    <label for="api-token">API Token:</label>
                    <input type="text" id="api-token" class="token-input" placeholder="Enter your API token from transitgames.xyz here" />
                    <button class="init-btn" id="init-maps">Initialize Maps</button>
                    <span id="token-status" class="token-status pending">Enter token</span>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    <strong>Token Required:</strong> All APIs including map styles are accessed through your authenticated token.
                </p>
            </div>
        </section>

        <section id="leaderboard-section" class="leaderboard-section">
            <div class="leaderboard-header">
                <h3> Leaderboard</h3>
                <button class="refresh-leaderboard-btn" id="refresh-leaderboard" disabled>Refresh</button>
            </div>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Score</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">Initialize maps to load leaderboard</td>
                    </tr>
                </tbody>
            </table>
            <div class="leaderboard-status" id="leaderboard-status">Leaderboard will load after initialization</div>
        </section>

        <section id="game-maps-section">
            <h2>Maps</h2>
            <div class="maps-container">
                <div id="maptiler-map">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <p>Enter API token and click "Initialize Maps" to load the game</p>
                    </div>
                </div>
                <div id="overlay-map">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 12px; text-align: center; padding: 10px;">
                        <p>Maps will load after initialization</p>
                    </div>
                </div>
            </div>
            <div class="submit-container">
                <button class="new-location-btn" id="new-location" disabled>New Location</button>
                <button class="submit-btn" id="submit-guess" disabled>Submit</button>
            </div>
        </section>
        <section id="game-answers-section">
            <h2>Game Answers</h2>
            <ul>
                <li id="location-text">Initialize maps to begin playing</li>
                <li id="guessed-coords">The guessed coordinates will appear here</li>
                <li id="submit-status">Game status will appear here</li>
                <li id="points-score">Points will be calculated here</li>
                <li id="round-count">Round: 1</li>
                <li class="score-post-status" id="score-post-status">Score posting status will appear here</li>
            </ul>
        </section>


        <section id="account-page" style="display:none;">
            <h2>Account Information</h2>
            <p><strong>User ID:</strong> <span id="account-user-id">Not available</span></p>
            <p><strong>Client ID:</strong> <span id="account-client-id">Not available</span></p>
            <p><strong>Token Expiry:</strong> <span id="account-token-expiry">Not available</span></p>
            <p><strong>Token Issued At:</strong> <span id="account-token-iat">Not available</span></p>
            <p><strong>Token Type:</strong> <span id="account-token-type">Not available</span></p>
            <p><strong>Token Active:</strong> <span id="account-token-active">Not available</span></p>
        </section>
    </main>
    <footer>
        <p>Made by Nathann and Jason</p>
    </footer>


    <div id="round-score-display"></div>
    <div id="total-score-display"></div>


    <script>
        // --- OAuth Configuration ---
        const OAUTH_CLIENT_ID = 'mapguessr-github-io.pages.dev'; // IMPORTANT: Replace with your actual client_id from transitspotter
        const OAUTH_REDIRECT_URI = window.location.href.split('?')[0]; // Assumes the current page handles the callback and is registered
        const AUTH_SERVER_BASE_URL = 'https://auth.transitspotter.com';


        // --- Map Guessr Configuration ---
        // API configuration
        let API_BASE_URL = 'https://mapguessr-worker.games-6cb.workers.dev';
        let API_TOKEN = '';

        let currentMarker = null;
        let userGuessLngLat = null;
        let guessPinElement = null;
        let currentLocationCoords = null;
        let totalScore = 0;
        let mainMap = null;
        let overlayMap = null;
        let realLocationPinElement = null;
        let roundCount = 1;
        let mapsInitialized = false; // New flag for map initialization status
        let userScore = null; // Store current user score info

        const zoomLevel = 15;
        const initialCenter = [0, 0];
        const initialZoom = -1.0;
        let lineLayerVisible = false;

        // Style IDs for your custom MapTiler styles
        const MAIN_STYLE_ID = '0196cb69-f55f-71f8-9a8f-90fa083f0f67';
        const OVERLAY_STYLE_ID = '0196cb7f-9914-7a9b-aed1-8bfa7b9a0705';


        // --- Application State ---
        let isAuthenticated = false;
        let currentPage = 'game'; // 'game' or 'account'


        // --- OAuth Helper Functions ---
        async function generateCodeVerifierAndChallenge() {
            const codeVerifier = generateRandomString(64);
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
            return { codeVerifier, codeChallenge };
        }


        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const randomValues = new Uint8Array(length);
            crypto.getRandomValues(randomValues);
            for (let i = 0; i < length; i++) {
                result += charset[randomValues[i] % charset.length];
            }
            return result;
        }


        async function startOAuthFlow() {
            const { codeVerifier, codeChallenge } = await generateCodeVerifierAndChallenge();
            const state = generateRandomString(32);
            sessionStorage.setItem('code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);


            const authUrl = new URL(`${AUTH_SERVER_BASE_URL}/external/authorize`);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('client_id', OAUTH_CLIENT_ID);
            authUrl.searchParams.append('redirect_uri', OAUTH_REDIRECT_URI);
            authUrl.searchParams.append('code_challenge', codeChallenge);
            authUrl.searchParams.append('code_challenge_method', 'S256');
            authUrl.searchParams.append('state', state);
            window.location.href = authUrl.toString();
        }


        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');


            if (error) {
                console.error('OAuth error:', error, urlParams.get('error_description'));
                // Using a custom message box instead of alert()
                showMessageBox(`OAuth Error: ${error} - ${urlParams.get('error_description') || 'Unknown error'}`);
                return false;
            }


            const storedState = sessionStorage.getItem('oauth_state');
            if (!state || state !== storedState) {
                console.error('Invalid state parameter');
                showMessageBox('Error: Invalid state. CSRF attack suspected.');
                return false;
            }


            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error('Code verifier not found');
                showMessageBox('Error: Code verifier missing. Please try logging in again.');
                return false;
            }


            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: OAUTH_CLIENT_ID,
                        redirect_uri: OAUTH_REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });
                const tokenData = await response.json();


                if (tokenData.error) {
                    console.error('Token error:', tokenData.error, tokenData.error_description);
                    showMessageBox(`Token Error: ${tokenData.error} - ${tokenData.error_description || 'Failed to get token'}`);
                    return false;
                }


                localStorage.setItem('access_token', tokenData.access_token);
                localStorage.setItem('refresh_token', tokenData.refresh_token);
                localStorage.setItem('token_expiry', Date.now() + (tokenData.expires_in * 1000));


                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');
                return true;
            } catch (err) {
                console.error('Token exchange error:', err);
                showMessageBox('Error exchanging code for token. Please check console.');
                return false;
            }
        }


        async function refreshToken() {
            const refreshTokenVal = localStorage.getItem('refresh_token');
            if (!refreshTokenVal) return false;


            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        grant_type: 'refresh_token',
                        refresh_token: refreshTokenVal,
                        client_id: OAUTH_CLIENT_ID
                    })
                });
                const tokenData = await response.json();


                if (tokenData.error) {
                    console.error('Refresh error:', tokenData.error, tokenData.error_description);
                    localStorage.clear();
                    return false;
                }
                localStorage.setItem('access_token', tokenData.access_token);
                if (tokenData.refresh_token) {
                    localStorage.setItem('refresh_token', tokenData.refresh_token);
                }
                localStorage.setItem('token_expiry', Date.now() + (tokenData.expires_in * 1000));
                return true;
            } catch (error) {
                console.error('Token refresh error:', error);
                return false;
            }
        }


        async function ensureValidToken() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) return false;


            const expiryTime = parseInt(localStorage.getItem('token_expiry'), 10);
            if (isNaN(expiryTime)) {
                localStorage.clear();
                return false;
            }
            if (Date.now() > expiryTime - 60000) { // Refresh if expiring in the next minute
                console.log("Token expired or expiring soon, attempting refresh...");
                return await refreshToken();
            }
            return true;
        }


        async function appLogout() {
            const refreshTokenVal = localStorage.getItem('refresh_token');
            if (refreshTokenVal) {
                try {
                    await fetch(`${AUTH_SERVER_BASE_URL}/external/revoke`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Origin': window.location.origin
                        },
                        body: JSON.stringify({
                            token: refreshTokenVal,
                            token_type_hint: 'refresh_token'
                        })
                    });
                } catch (error) {
                    console.error('Error revoking token:', error);
                }
            }
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('token_expiry');
            isAuthenticated = false;
            resetGameAndUI();
            updateAuthUI();
            currentPage = 'game'; // Reset to game page on logout
            showPage(currentPage);
        }
       
        function resetGameAndUI() {
            // Remove map instances if they exist
            if (mainMap) { mainMap.remove(); mainMap = null; }
            if (overlayMap) { overlayMap.remove(); overlayMap = null; }
            mapsInitialized = false; // Reset map initialization flag

            // Clear markers and pins
            if (currentMarker) { currentMarker.remove(); currentMarker = null; }
            if (guessPinElement) { guessPinElement.remove(); guessPinElement = null; }
            if (realLocationPinElement) { realLocationPinElement.remove(); realLocationPinElement = null; }
           
            // Reset game state variables
            userGuessLngLat = null;
            currentLocationCoords = null;
            totalScore = 0;
            roundCount = 1;
            lineLayerVisible = false; // Assuming this should be reset
            userScore = null; // Reset user score

            // Reset UI text elements
            document.getElementById('location-text').textContent = 'Initialize maps to begin playing';
            document.getElementById('guessed-coords').textContent = 'The guessed coordinates will appear here';
            document.getElementById('submit-status').textContent = 'Game status will appear here';
            document.getElementById('points-score').textContent = 'Points will be calculated here';
            document.getElementById('round-count').textContent = 'Round: 1';
            document.getElementById('score-post-status').textContent = '';

            const existingNextButton = document.getElementById('next-round-btn');
            if (existingNextButton) existingNextButton.remove();

            document.getElementById('round-score-display').style.display = 'none';
            document.getElementById('total-score-display').style.display = 'none';

            // Disable game buttons
            document.getElementById('submit-guess').disabled = true;
            document.getElementById('new-location').disabled = true;
            document.getElementById('refresh-leaderboard').disabled = true;

            // Reset API token input and status
            document.getElementById('api-token').value = '';
            document.getElementById('api-token').disabled = false;
            document.getElementById('init-maps').disabled = false;
            document.getElementById('init-maps').textContent = 'Initialize Maps';
            updateTokenStatus('pending', 'Enter token');

            // Clear leaderboard
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; color: #666;">Initialize maps to load leaderboard</td>
                </tr>
            `;
            document.getElementById('leaderboard-status').textContent = 'Leaderboard will load after initialization';

            // Reset map placeholders
            document.getElementById('maptiler-map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                    <p>Enter API token and click "Initialize Maps" to load the game</p>
                </div>
            `;
            document.getElementById('overlay-map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 12px; text-align: center; padding: 10px;">
                    <p>Maps will load after initialization</p>
                </div>
            `;
        }


        // Custom message box function instead of alert()
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #f44336; /* Red background for error */
                color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                z-index: 2000;
                font-size: 1.2em;
                text-align: center;
                max-width: 80%;
            `;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);


            setTimeout(() => {
                messageBox.remove();
            }, 5000); // Remove after 5 seconds
        }


        async function fetchAndDisplayUserInfo() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                document.getElementById('account-user-id').textContent = 'Not logged in.';
                return;
            }


            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/introspect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        token: accessToken,
                        token_type_hint: 'access_token'
                    })
                });
                const userData = await response.json();


                if (userData.active) {
                    document.getElementById('account-user-id').textContent = userData.sub || 'N/A';
                    document.getElementById('account-client-id').textContent = userData.client_id || 'N/A';
                    document.getElementById('account-token-type').textContent = userData.token_type || 'N/A';
                    document.getElementById('account-token-active').textContent = 'Yes';


                    if (userData.exp) {
                        const expiryDate = new Date(userData.exp * 1000);
                        document.getElementById('account-token-expiry').textContent = expiryDate.toLocaleString();
                    } else {
                        document.getElementById('account-token-expiry').textContent = 'N/A';
                    }


                    if (userData.iat) {
                        const issuedAtDate = new Date(userData.iat * 1000);
                        document.getElementById('account-token-iat').textContent = issuedAtDate.toLocaleString();
                    } else {
                        document.getElementById('account-token-iat').textContent = 'N/A';
                    }
                    document.getElementById('user-info').textContent = `Logged In as: ${userData.sub || 'User'}`;
                } else {
                    document.getElementById('account-user-id').textContent = 'Token is inactive.';
                    document.getElementById('account-client-id').textContent = 'N/A';
                    document.getElementById('account-token-expiry').textContent = 'N/A';
                    document.getElementById('account-token-iat').textContent = 'N/A';
                    document.getElementById('account-token-type').textContent = 'N/A';
                    document.getElementById('account-token-active').textContent = 'No';
                    document.getElementById('user-info').textContent = `Logged In (Token Inactive)`;
                }


            } catch (error) {
                console.error('Error fetching user info:', error);
                document.getElementById('account-user-id').textContent = 'Error fetching user info.';
                document.getElementById('user-info').textContent = `Logged In (Error)`;
            }
        }


        // --- UI Update Functions ---
        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const myAccountBtn = document.getElementById('my-account-btn');
            const userInfoDisplay = document.getElementById('user-info');
            const mainContent = document.querySelector('main');


            if (isAuthenticated) {
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                myAccountBtn.style.display = 'inline-block';
                mainContent.style.display = 'block'; // Show main content area
                fetchAndDisplayUserInfo(); // Fetch and display user info when authenticated
                // Game initialization is now triggered by the "Initialize Maps" button
            } else {
                loginBtn.style.display = 'inline-block';
                registerBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                myAccountBtn.style.display = 'none';
                userInfoDisplay.textContent = ''; // Clear user info
                mainContent.style.display = 'none'; // Hide main content area
                resetGameAndUI(); // Reset game state and UI on logout
                // Clear account info display
                document.getElementById('account-user-id').textContent = 'Not logged in.';
                document.getElementById('account-client-id').textContent = 'Not available';
                document.getElementById('account-token-expiry').textContent = 'Not available';
                document.getElementById('account-token-iat').textContent = 'Not available';
                document.getElementById('account-token-type').textContent = 'Not available';
                document.getElementById('account-token-active').textContent = 'Not available';
            }
            showPage(currentPage); // Ensure correct page is shown
        }


        function showPage(pageName) {
            const gameSections = document.querySelectorAll('#game-section, #leaderboard-section, #game-maps-section, #game-answers-section');
            const accountPage = document.getElementById('account-page');


            if (pageName === 'game') {
                gameSections.forEach(section => section.style.display = 'block');
                accountPage.style.display = 'none';
                // Game initialization is now triggered by the "Initialize Maps" button
            } else if (pageName === 'account') {
                gameSections.forEach(section => section.style.display = 'none');
                accountPage.style.display = 'block';
            }
            currentPage = pageName;
        }

        // --- Token Authentication Functions (from New imp) ---
        function updateTokenStatus(status, message) {
            const statusElement = document.getElementById('token-status');
            statusElement.className = `token-status ${status}`;
            statusElement.textContent = message;
        }

        function validateToken(token) {
            if (!token || token.trim() === '') {
                updateTokenStatus('invalid', 'Token required');
                return false;
            }
            
            if (token.length < 10) {
                updateTokenStatus('invalid', 'Token too short');
                return false;
            }
            
            updateTokenStatus('valid', 'Token format valid');
            return true;
        }

        async function testTokenAuth() {
            if (!API_TOKEN) {
                updateTokenStatus('invalid', 'No token set');
                return false;
            }

            try {
                // Test the token with a simple API call
                const response = await fetch(`${API_BASE_URL}/api/cities?token=${API_TOKEN}`);
                
                if (response.ok) {
                    updateTokenStatus('valid', 'Token verified');
                    return true;
                } else if (response.status === 401 || response.status === 403) {
                    updateTokenStatus('invalid', 'Invalid token');
                    return false;
                } else {
                    updateTokenStatus('invalid', 'API error');
                    return false;
                }
            } catch (error) {
                updateTokenStatus('invalid', 'Connection error');
                return false;
            }
        }

        async function loadMapStyles() {
            if (!API_TOKEN) {
                throw new Error('No API token available');
            }

            // Build style URLs using your API endpoints
            const customStyleUrl = `${API_BASE_URL}/api/mapstyle?style=${MAIN_STYLE_ID}&token=${API_TOKEN}`;
            const overlayStyleUrl = `${API_BASE_URL}/api/mapstyle?style=${OVERLAY_STYLE_ID}&token=${API_TOKEN}`;

            // Test that the style endpoints are accessible
            try {
                const mainStyleTest = await fetch(customStyleUrl);
                const overlayStyleTest = await fetch(overlayStyleUrl);
                
                if (!mainStyleTest.ok || !overlayStyleTest.ok) {
                    throw new Error('Cannot access map style APIs');
                }
                
                console.log('Map styles accessible via API');
                return { customStyleUrl, overlayStyleUrl };
                
            } catch (error) {
                console.error('Error testing map style APIs:', error);
                throw new Error('Map style APIs not accessible');
            }
        }

        // --- Leaderboard Functions (from New imp) ---
        async function fetchLeaderboard() {
            const statusElement = document.getElementById('leaderboard-status');
            
            try {
                statusElement.textContent = 'Loading leaderboard...';
                
                // Fetch leaderboard (no authentication required)
                const response = await fetch(`${API_BASE_URL}/api/leaderboard`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                displayLeaderboard(data.leaderboard);
                statusElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                statusElement.textContent = `Error loading leaderboard: ${error.message}`;
                
                // Show error in leaderboard table
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #dc3545;">
                            Failed to load leaderboard
                        </td>
                    </tr>
                `;
            }
        }

        function displayLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboard-body');
            
            if (!leaderboard || leaderboard.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">
                            No players on leaderboard yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = leaderboard.map(player => {
                const rankClass = `rank-${player.rank}`;
                const lastUpdated = new Date(player.lastUpdated).toLocaleDateString();
                
                return `
                    <tr>
                        <td class="${rankClass}">#${player.rank}</td>
                        <td class="${rankClass}">${player.name}</td>
                        <td class="${rankClass}">${player.score.toLocaleString()}</td>
                        <td>${lastUpdated}</td>
                    </tr>
                `;
            }).join('');
        }

        async function fetchUserScore() {
            if (!API_TOKEN) {
                return null;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/score?token=${API_TOKEN}`);
                
                if (response.ok) {
                    const scoreData = await response.json();
                    userScore = scoreData;
                    console.log('Current user score:', userScore);
                    return scoreData;
                } else if (response.status === 401 || response.status === 403) {
                    console.warn('Score fetch failed: Authentication error');
                    return null;
                } else {
                    console.warn('Score fetch failed:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching user score:', error);
                return null;
            }
        }

        async function postScore(score) {
            if (!API_TOKEN || !score || score <= 0) {
                return false;
            }

            const statusElement = document.getElementById('score-post-status');
            
            try {
                statusElement.textContent = 'Posting score to leaderboard...';
                
                const response = await fetch(`${API_BASE_URL}/api/score?token=${API_TOKEN}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ score: score })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.textContent = `Score posted! New total: ${result.newTotalScore.toLocaleString()} (+${score})`;
                    
                    // Update local user score
                    userScore = {
                        score: result.newTotalScore,
                        userId: result.userId,
                        name: result.name,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Refresh leaderboard to show updated scores
                    setTimeout(() => {
                        fetchLeaderboard();
                    }, 1000);
                    
                    return true;
                } else if (response.status === 401 || response.status === 403) {
                    statusElement.textContent = 'Score posting failed: Authentication error';
                    return false;
                } else {
                    statusElement.textContent = `Score posting failed: HTTP ${response.status}`;
                    return false;
                }
            } catch (error) {
                console.error('Error posting score:', error);
                statusElement.textContent = `Score posting failed: ${error.message}`;
                return false;
            }
        }
       
        // --- Original Game Functions ---
        function getRandomCoordinateInBounds(bounds) {
            const minLng = bounds[0];
            const minLat = bounds[1];
            const maxLng = bounds[2];
            const maxLat = bounds[3];
            const buffer = 0.001;
            const bufferedMinLng = minLng + (maxLng - minLng) * buffer;
            const bufferedMinLat = minLat + (maxLat - minLat) * buffer;
            const bufferedMaxLng = maxLng - (maxLng - minLng) * buffer;
            const bufferedMaxLat = maxLat - (maxLat - minLat) * buffer;
            const randomLng = bufferedMinLng + (bufferedMaxLng - bufferedMinLng) * Math.random();
            const randomLat = bufferedMinLat + (bufferedMaxLat - bufferedMinLat) * Math.random();
            return [randomLng, randomLat];
        }


        function addOrUpdateMarker(lngLatInput) {
            const lngLatObject = Array.isArray(lngLatInput) ? new maptilersdk.LngLat(lngLatInput[0], lngLatInput[1]) : lngLatInput;
            if (!(lngLatObject instanceof maptilersdk.LngLat) || typeof lngLatObject.lng !== 'number' || typeof lngLatObject.lat !== 'number') {
                console.error("addOrUpdateMarker received invalid LngLat data:", lngLatInput);
                return;
            }
            if (currentMarker) {
                currentMarker.remove();
            }
            currentMarker = new maptilersdk.Marker()
                .setLngLat(lngLatObject)
                .addTo(mainMap);
            currentLocationCoords = lngLatObject;
            if (currentMarker && currentMarker.getElement()) {
                currentMarker.getElement().style.display = 'none';
            }
            console.log("currentLocationCoords set to LngLat object:", currentLocationCoords);
        }


        function calculateDistanceInMeters(lat1, lon1, lat2, lon2) {
            if (typeof lat1 !== 'number' || typeof lon1 !== 'number' || typeof lat2 !== 'number' || typeof lon2 !== 'number') {
                console.error("Invalid input types for calculateDistanceInMeters:", lat1, lon1, lat2, lon2);
                return NaN;
            }
            const R = 6371e3; // Earth's radius in meters
            const 1 = lat1 * Math.PI / 180; // , 位 in radians
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const 位 = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin( / 2) * Math.sin( / 2) + Math.cos(1) * Math.cos(2) * Math.sin(位 / 2) * Math.sin(位 / 2);
            const c = 2 * Math.atan2(Math.sqrt(Math.max(0, a)), Math.sqrt(Math.max(0, 1 - a)));
            const distance = R * c; // Distance in meters
            return distance;
        }


        function calculateGeoGuessrScore(lat1, lon1, lat2, lon2) {
            const MAX_SCORE = 5000; // Maximum points per round
            const FIVE_K_THRESHOLD_METERS = 100; // A small distance for a guaranteed 5000
            const distance = calculateDistanceInMeters(lat1, lon1, lat2, lon2);
            if (isNaN(distance)) {
                console.error("Distance calculation returned NaN.");
                return { distance: NaN, score: NaN }; // Propagate NaN if distance is invalid
            }
            let score;
            if (distance <= FIVE_K_THRESHOLD_METERS) {
                score = MAX_SCORE;
            } else {
                const decayFactor = 2000000; // Adjust based on desired scoring curve
                score = MAX_SCORE * Math.exp(-distance / decayFactor);
                score = Math.max(0, Math.round(score));
            }
            return { distance: distance, score: score };
        }


        function updateGuessPinPosition() {
            if (!overlayMap || !userGuessLngLat || !guessPinElement) return;
            if (!(userGuessLngLat instanceof maptilersdk.LngLat) || typeof userGuessLngLat.lng !== 'number' || typeof userGuessLngLat.lat !== 'number') {
                console.error("Invalid userGuessLngLat object for positioning:", userGuessLngLat);
                return;
            }
            const pixelCoords = overlayMap.project(userGuessLngLat);
            guessPinElement.style.left = `${pixelCoords.x}px`;
            guessPinElement.style.top = `${pixelCoords.y}px`;
            guessPinElement.style.display = 'block';
        }


        function updateRealLocationPinPosition() {
            if (!overlayMap || !currentLocationCoords || !realLocationPinElement) return;
            if (!(currentLocationCoords instanceof maptilersdk.LngLat) || typeof currentLocationCoords.lng !== 'number' || typeof currentLocationCoords.lat !== 'number') {
                console.error("Invalid currentLocationCoords object for positioning:", currentLocationCoords);
                return;
            }
            const pixelCoords = overlayMap.project(currentLocationCoords);
            realLocationPinElement.style.left = `${pixelCoords.x}px`;
            realLocationPinElement.style.top = `${pixelCoords.y}px`;
            realLocationPinElement.style.display = 'block';
        }
       
        function placeCustomGuessPinOnOverlay(lngLat) {
            console.log('Attempting to place custom guess pin at LngLat:', lngLat);
            userGuessLngLat = lngLat;
            if (guessPinElement) {
                console.log('Removing existing custom guess pin element.');
                guessPinElement.remove();
            }
            guessPinElement = document.createElement('div');
            guessPinElement.className = 'guess-pin';
            overlayMap.getCanvasContainer().appendChild(guessPinElement);
            console.log('New custom guess pin element created:', guessPinElement);
            updateGuessPinPosition();
            document.getElementById('guessed-coords').textContent = `Guessed Location: Lng: ${lngLat.lng.toFixed(6)}, Lat: ${lngLat.lat.toFixed(6)}`;
            document.getElementById('submit-status').textContent = 'Guess placed. Click Submit!';
            overlayMap.off('move', updateGuessPinPosition); // Remove previous to avoid duplicates
            overlayMap.on('move', updateGuessPinPosition);
            console.log("Guess pin placed and move listener added. userGuessLngLat:", userGuessLngLat);
        }


        function placeCustomRealLocationPinOnOverlay(lngLat) {
            console.log('Attempting to place custom real location pin at LngLat:', lngLat);
            if (realLocationPinElement) {
                console.log('Removing existing custom real location pin element.');
                realLocationPinElement.remove();
            }
            realLocationPinElement = document.createElement('div');
            realLocationPinElement.className = 'real-location-pin';
            overlayMap.getCanvasContainer().appendChild(realLocationPinElement);
            console.log('New custom real location pin element created:', realLocationPinElement);
            updateRealLocationPinPosition();
            overlayMap.off('move', updateRealLocationPinPosition); // Remove previous to avoid duplicates
            overlayMap.on('move', updateRealLocationPinPosition);
            console.log("Real location pin placed and move listener added. currentLocationCoords:", currentLocationCoords);
        }
       
        function updateLineBetweenPins() {
            if (!lineLayerVisible || !overlayMap || !userGuessLngLat || !currentLocationCoords) return;
            if (!(userGuessLngLat instanceof maptilersdk.LngLat) || typeof userGuessLngLat.lng !== 'number' || typeof userGuessLngLat.lat !== 'number' ||
                !(currentLocationCoords instanceof maptilersdk.LngLat) || typeof currentLocationCoords.lng !== 'number' || typeof currentLocationCoords.lat !== 'number') {
                console.error("Invalid LngLat objects for drawing line:", userGuessLngLat, currentLocationCoords);
                return;
            }
            const lineGeoJSON = {
                'type': 'Feature',
                'geometry': { 'type': 'LineString', 'coordinates': [ [userGuessLngLat.lng, userGuessLngLat.lat], [currentLocationCoords.lng, currentLocationCoords.lat] ] }
            };
            if (overlayMap.getSource('line-source')) {
                overlayMap.getSource('line-source').setData(lineGeoJSON);
            }
        }


        async function findRandomCityAndSpot(attempt = 1) {
            const locationText = document.getElementById('location-text');
            const newLocationBtn = document.getElementById('new-location');
            const submitGuessBtn = document.getElementById('submit-guess');


            locationText.textContent = 'Finding a new location...';
            document.getElementById('guessed-coords').textContent = 'Make your guess on the overlay map...';
            document.getElementById('submit-status').textContent = 'Place your guess on the overlay map...';
            document.getElementById('points-score').textContent = 'Points: - | Total: ' + totalScore + ' points';
            document.getElementById('round-score-display').style.display = 'none';
            document.getElementById('total-score-display').style.display = 'none';
            document.getElementById('score-post-status').textContent = '';


            if (currentMarker) { currentMarker.remove(); currentMarker = null; }
            if (guessPinElement) {
                guessPinElement.remove(); guessPinElement = null;
                userGuessLngLat = null;
                if(overlayMap) overlayMap.off('move', updateGuessPinPosition);
                console.log("Custom guess pin element and move listener removed.");
            }
            if (realLocationPinElement) { realLocationPinElement.remove(); realLocationPinElement = null; if(overlayMap) overlayMap.off('move', updateRealLocationPinPosition); }
            currentLocationCoords = null;


            if (overlayMap && overlayMap.getLayer('line-layer')) {
                overlayMap.setLayoutProperty('line-layer', 'visibility', 'none');
                lineLayerVisible = false;
            }


            const existingNextButton = document.getElementById('next-round-btn');
            if (existingNextButton) existingNextButton.remove();


            submitGuessBtn.disabled = false;
            newLocationBtn.disabled = false;


            const MAX_LOCATION_RETRIES = 10;
            if (attempt > MAX_LOCATION_RETRIES) {
                locationText.textContent = `Failed to find a valid city location after ${MAX_LOCATION_RETRIES} attempts. Please check the console for errors.`;
                console.error(`Failed to find a valid city location after ${MAX_LOCATION_RETRIES} attempts.`);
                return;
            }
            console.log(`Attempting to find random city (Attempt ${attempt}/${MAX_LOCATION_RETRIES})...`);
            locationText.textContent = `Finding a random city (Attempt ${attempt})...`;


            try {
                // Fetch random city via your API
                const cityApiUrl = `${API_BASE_URL}/api/cities?token=${API_TOKEN}`;
                const cityResponse = await fetch(cityApiUrl);
                
                if (!cityResponse.ok) {
                    if (cityResponse.status === 401 || cityResponse.status === 403) {
                        updateTokenStatus('invalid', 'Token expired');
                        locationText.textContent = 'Authentication failed. Please refresh your token.';
                        return;
                    }
                    throw new Error(`HTTP error fetching random city: ${cityResponse.status}`);
                }
                
                const cityData = await cityResponse.json();
                const cityName = cityData.city;

                if (!cityName) {
                    console.warn(`Random City API returned no city name (Attempt ${attempt}). Retrying...`);
                    findRandomCityAndSpot(attempt + 1);
                    return;
                }

                console.log(`Successfully fetched city: ${cityName}. Finding geocoding data...`);
                locationText.textContent = `Finding a random spot in ${cityName}...`;

                // Get geocoding data via your API
                const geocodingUrl = `${API_BASE_URL}/api/geocode?city=${encodeURIComponent(cityName)}&token=${API_TOKEN}`;
                const geocodingResponse = await fetch(geocodingUrl);
                
                if (!geocodingResponse.ok) {
                    if (geocodingResponse.status === 401 || geocodingResponse.status === 403) {
                        updateTokenStatus('invalid', 'Token expired');
                        locationText.textContent = 'Authentication failed. Please refresh your token.';
                        return;
                    }
                    console.warn(`HTTP error geocoding "${cityName}" (Attempt ${attempt}): ${geocodingResponse.status}. Retrying...`);
                    findRandomCityAndSpot(attempt + 1);
                    return;
                }
                
                const geocodingData = await geocodingResponse.json();

                if (geocodingData && geocodingData.features && geocodingData.features.length > 0) {
                    const feature = geocodingData.features[0];
                    const bounds = feature.bbox;
                    const center = feature.center;

                    let randomLngLatArray;

                    if (bounds) {
                        randomLngLatArray = getRandomCoordinateInBounds(bounds);
                        console.log("Using bounds to find random coordinate array:", randomLngLatArray);
                    } else if (center) {
                        const randomLng = center[0] + (Math.random() - 0.5) * 0.02;
                        const randomLat = center[1] + (Math.random() - 0.5) * 0.02;
                        randomLngLatArray = [randomLng, randomLat];
                        console.log("Using center with offset to find random coordinate array:", randomLngLatArray);
                    } else {
                        console.warn(`Geocoding API could not find detailed location data for "${cityName}" (Attempt ${attempt}). Retrying...`);
                        findRandomCityAndSpot(attempt + 1);
                        return;
                    }

                    console.log("Setting main map view to:", randomLngLatArray, "at zoom", zoomLevel);
                    if (mainMap) {
                        mainMap.jumpTo({
                            center: randomLngLatArray,
                            zoom: zoomLevel,
                            essential: true
                        });
                    } else {
                        console.error("mainMap not initialized when trying to jumpTo.");
                    }

                    document.getElementById('location-text').textContent = `Location: A random spot in ${feature.place_name || cityName}`;

                    addOrUpdateMarker(randomLngLatArray);

                    console.log("New location setup complete via API. currentLocationCoords:", currentLocationCoords);

                } else {
                    console.warn(`Geocoding API could not find the location for "${cityName}" (Attempt ${attempt}). Retrying...`);
                    findRandomCityAndSpot(attempt + 1);
                }

            } catch (error) {
                console.error(`Error during API call (Attempt ${attempt}):`, error);
                locationText.textContent = `An error occurred fetching location: ${error.message}. Retrying...`;
                findRandomCityAndSpot(attempt + 1);
            }
        }
       
        // --- Game Initialization (Called after successful authentication) ---
        async function initializeGame() {
            if (mapsInitialized) return; // Ensure this runs only once

            const tokenInput = document.getElementById('api-token');
            const token = tokenInput.value.trim();
            
            if (!validateToken(token)) {
                return false;
            }
            
            API_TOKEN = token;
            
            // Test token authentication
            const authValid = await testTokenAuth();
            if (!authValid) {
                return false;
            }

            // Load map styles through API
            let styleUrls;
            try {
                updateTokenStatus('pending', 'Loading styles...');
                styleUrls = await loadMapStyles();
            } catch (error) {
                updateTokenStatus('invalid', 'Style load failed');
                console.error('Failed to load map styles:', error);
                return false;
            }

            try {
                // Clear the placeholder content
                document.getElementById('maptiler-map').innerHTML = '';
                document.getElementById('overlay-map').innerHTML = '';

                // Configure MapTiler SDK to use your API as a source transform
                // This tells the SDK how to handle requests
                maptilersdk.config.apiKey = 'dummy'; // Required but not used since we're using custom URLs

                // Initialize the main map with your API style URL
                mainMap = new maptilersdk.Map({
                    container: 'maptiler-map',
                    style: styleUrls.customStyleUrl,
                    center: [0, 0],
                    zoom: 1,
                    interactive: false
                });

                // Initialize the overlay map with your API style URL
                overlayMap = new maptilersdk.Map({
                    container: 'overlay-map',
                    style: styleUrls.overlayStyleUrl,
                    center: initialCenter,
                    zoom: initialZoom,
                    interactive: true
                });

                // Set up event listeners
                setupMapEventListeners();
                
                mapsInitialized = true;
                updateTokenStatus('valid', 'Maps loaded');
                
                // Enable game buttons
                document.getElementById('new-location').disabled = false;
                document.getElementById('submit-guess').disabled = false;
                document.getElementById('refresh-leaderboard').disabled = false;
                
                // Update status
                document.getElementById('location-text').textContent = 'Maps initialized! Click "New Location" to start playing.';
                
                // Load user score and leaderboard
                await fetchUserScore();
                await fetchLeaderboard();
                
                return true;
                
            } catch (error) {
                console.error('Error initializing maps:', error);
                updateTokenStatus('invalid', 'Map init failed');
                return false;
            }
        }

        function setupMapEventListeners() {
            // Add error listeners
            mainMap.on('error', (e) => {
                console.error('Main map loading error:', e.error);
                document.getElementById('location-text').textContent = "Error loading main map. Check console.";
            });

            overlayMap.on('error', (e) => {
                console.error('Overlay map loading error:', e.error);
                document.getElementById('guessed-coords').textContent = "Error loading overlay map. Check console.";
            });

            // Style load handlers
            mainMap.on('style.load', () => {
                console.log('Main map style loaded from API.');
                try {
                    mainMap.getContainer().querySelectorAll('.maptiler-ctrl, .maplibregl-ctrl').forEach(ctrl => ctrl.remove());
                } catch (e) {
                    console.warn("Could not remove controls programmatically for main map:", e);
                }
            });

            overlayMap.on('style.load', () => {
                console.log('Overlay map style loaded from API.');
                try {
                    overlayMap.getContainer().querySelectorAll('.maptiler-ctrl, .maplibregl-ctrl').forEach(ctrl => ctrl.remove());
                } catch (e) {
                    console.warn("Could not remove controls programmatically for overlay map:", e);
                }
                overlayMap.addSource('line-source', {
                    'type': 'geojson',
                    'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } }
                });
                overlayMap.addLayer({
                    'id': 'line-layer', 'type': 'line', 'source': 'line-source',
                    'layout': { 'line-join': 'round', 'line-cap': 'round', 'visibility': 'none' },
                    'paint': { 'line-color': '#000', 'line-width': 2, 'line-dasharray': [0.5, 2] }
                });
                overlayMap.on('move', updateLineBetweenPins);
            });

            // Click handlers for overlay map
            overlayMap.on('click', (e) => {
                if (!overlayMap.getContainer().classList.contains('overlay-map-fullscreen')) {
                    const clickedLngLat = e.lngLat;
                    console.log('Overlay map left-clicked at:', clickedLngLat);
                    placeCustomGuessPinOnOverlay(clickedLngLat);
                }
            });

            overlayMap.on('contextmenu', (e) => {
                e.preventDefault();
                if (!overlayMap.getContainer().classList.contains('overlay-map-fullscreen')) {
                    const clickedLngLat = e.lngLat;
                    console.log('Overlay map right-clicked at:', clickedLngLat);
                    placeCustomGuessPinOnOverlay(clickedLngLat);
                }
            });

            // Resize handler
            const overlayMapElement = document.getElementById('overlay-map');
            overlayMapElement.addEventListener('transitionend', () => {
                console.log('Overlay map container transition ended. Resizing map.');
                if (overlayMap) {
                    overlayMap.resize();
                    if (guessPinElement && userGuessLngLat) updateGuessPinPosition();
                    if (realLocationPinElement && currentLocationCoords) updateRealLocationPinPosition();
                    updateLineBetweenPins();
                }
            });
        }


        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('login-btn').addEventListener('click', startOAuthFlow);
            document.getElementById('register-btn').addEventListener('click', startOAuthFlow); // Register can also start the same flow
            document.getElementById('logout-btn').addEventListener('click', appLogout);
            document.getElementById('my-account-btn').addEventListener('click', () => {
                showPage(currentPage === 'account' ? 'game' : 'account');
            });

            // Initialize maps button
            document.getElementById('init-maps').addEventListener('click', async function() {
                this.disabled = true;
                this.textContent = 'Initializing...';
                
                const success = await initializeGame(); // Call the new initializeGame
                
                if (success) {
                    this.textContent = 'Maps Loaded';
                    document.getElementById('api-token').disabled = true;
                } else {
                    this.disabled = false;
                    this.textContent = 'Initialize Maps';
                }
            });

            // Token input validation
            const tokenInput = document.getElementById('api-token');
            tokenInput.addEventListener('input', function() {
                const token = this.value.trim();
                if (token) {
                    validateToken(token);
                } else {
                    updateTokenStatus('pending', 'Enter token');
                }
            });

            // Refresh leaderboard button
            document.getElementById('refresh-leaderboard').addEventListener('click', function() {
                if (mapsInitialized) {
                    fetchLeaderboard();
                }
            });

            // New Location button
            document.getElementById('new-location').addEventListener('click', function() {
                if (mapsInitialized && API_TOKEN) {
                    findRandomCityAndSpot();
                }
            });

            // Submit button
            document.getElementById('submit-guess').addEventListener('click', async function handleSubmitGuess() {
                console.log("Submit button clicked.");
                if (!userGuessLngLat || !(userGuessLngLat instanceof maptilersdk.LngLat)) {
                    document.getElementById('submit-status').textContent = 'Please make a guess by clicking or right-clicking on the map.';
                    console.warn("Submit clicked without a valid guess location.");
                    return;
                }
                if (!currentLocationCoords || !(currentLocationCoords instanceof maptilersdk.LngLat)) {
                    document.getElementById('submit-status').textContent = 'Error: No location set for scoring.';
                    console.error('Error: Submit clicked but currentLocationCoords is null or not a LngLat object.');
                    return;
                }
                const guessedLngLat = userGuessLngLat;
                const actualLngLat = currentLocationCoords;
                console.log("Actual LngLat for scoring:", actualLngLat);
                console.log("Guessed LngLat for scoring:", guessedLngLat);
                if (typeof actualLngLat.lat !== 'number' || typeof actualLngLat.lng !== 'number' || typeof guessedLngLat.lat !== 'number' || typeof guessedLngLat.lng !== 'number') {
                    console.error("Score Calculation Error: One or more coordinate values are not numbers.", {actual: actualLngLat, guessed: guessedLngLat});
                    document.getElementById('submit-status').textContent = 'Error: Cannot calculate score due to invalid coordinate data.';
                    return;
                }
                const scoreResult = calculateGeoGuessrScore(actualLngLat.lat, actualLngLat.lng, guessedLngLat.lat, guessedLngLat.lng);
                console.log("Score Calculation Result:", scoreResult);
                if (isNaN(scoreResult.score) || isNaN(scoreResult.distance)) {
                    console.error("Score calculation returned NaN.", scoreResult);
                    document.getElementById('submit-status').textContent = 'Error: Score calculation failed.';
                    return;
                }
                totalScore += scoreResult.score;
                document.getElementById('points-score').textContent = `Round Score: ${scoreResult.score} points (${(scoreResult.distance/1000).toFixed(2)} km) | Total Score: ${totalScore} points`;
                document.getElementById('submit-status').textContent = `Guess submitted! You were ${(scoreResult.distance/1000).toFixed(2)} km away.`;
                if (currentMarker && currentMarker.getElement()) {
                    currentMarker.getElement().style.display = 'block';
                    console.log("Showing actual location marker on main map.");
                } else { console.warn("Could not find currentMarker element to show."); }

                const overlayMapElem = document.getElementById('overlay-map');
                overlayMapElem.classList.add('overlay-map-fullscreen');
                overlayMap.resize();
                const bounds = new maptilersdk.LngLatBounds();
                bounds.extend(guessedLngLat);
                bounds.extend(actualLngLat);
                setTimeout(() => {
                    overlayMap.fitBounds(bounds, { padding: 50, duration: 1000, essential: true });
                }, 300);

                placeCustomRealLocationPinOnOverlay(actualLngLat);
                updateLineBetweenPins();
                if (overlayMap.getLayer('line-layer')) {
                    overlayMap.setLayoutProperty('line-layer', 'visibility', 'visible');
                    lineLayerVisible = true;
                }

                roundScoreDisplay.textContent = `Round Score: ${scoreResult.score} points`;
                totalScoreDisplay.textContent = `Total Score: ${totalScore} points`;
                roundScoreDisplay.style.display = 'block';
                totalScoreDisplay.style.display = 'block';

                // Post score to leaderboard
                if (scoreResult.score > 0) {
                    await postScore(scoreResult.score);
                }

                let nextButton = document.getElementById('next-round-btn');
                if (!nextButton) {
                    nextButton = document.createElement('button');
                    nextButton.textContent = 'Next Round';
                    nextButton.id = 'next-round-btn';
                    const mapsContainer = document.querySelector('.maps-container');
                    mapsContainer.appendChild(nextButton);
                    nextButton.addEventListener('click', () => {
                        overlayMapElem.classList.remove('overlay-map-fullscreen');
                        overlayMap.flyTo({ center: initialCenter, zoom: initialZoom, essential: true, duration: 500 });
                        if (realLocationPinElement) { realLocationPinElement.remove(); realLocationPinElement = null; }
                        if (guessPinElement) { guessPinElement.remove(); guessPinElement = null; }
                        userGuessLngLat = null;
                        if (overlayMap.getLayer('line-layer')) {
                            overlayMap.setLayoutProperty('line-layer', 'visibility', 'none');
                            lineLayerVisible = false;
                        }
                        roundScoreDisplay.style.display = 'none';
                        totalScoreDisplay.style.display = 'none';
                        nextButton.remove();
                        setTimeout(() => { if(overlayMap) overlayMap.resize(); }, 500); // Added check for overlayMap
                        roundCount++;
                        document.getElementById('round-count').textContent = `Round: ${roundCount}`;
                        findRandomCityAndSpot();
                    });
                }
                submitGuessBtn.disabled = true;
                newLocationBtn.disabled = true;
            });

            // Handle OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') && urlParams.has('state')) {
                const success = await handleOAuthCallback();
                if (success) {
                    isAuthenticated = true;
                    // Clean URL - remove OAuth parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    isAuthenticated = false;
                    // Error already alerted in handleOAuthCallback
                }
            } else {
                // Regular page load, check if already logged in via stored token
                isAuthenticated = await ensureValidToken();
            }
            updateAuthUI(); // This will show/hide game content and init if authenticated
        });
    </script>
</body>
</html>
