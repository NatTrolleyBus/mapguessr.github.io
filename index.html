<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Map Guessr</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptilersdk.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #0cc0df;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        header div {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        h1 {
            color: #444;
            margin-top: 0;
            margin-right: 20px;
        }
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #map-container {
            width: 100%;
            height: 500px;
            margin-bottom: 20px;
        }
        #game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #game-info div {
            font-size: 1.2em;
            font-weight: bold;
        }
        .buttons-container {
            margin-top: 20px;
            text-align: center;
        }
        button {
            background-color: #0cc0df;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0a9cb7;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .submit-btn {
            background-color: #28a745;
        }
        .submit-btn:hover {
            background-color: #218838;
        }
        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #leaderboard-table th, #leaderboard-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #leaderboard-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <header>
        <h1>Map Guessr</h1>
        <div>
            <button id="login-btn">Login</button>
            <button id="register-btn">Register</button>
            <button id="my-account-btn" style="display: none;">My Account</button>
            <button id="logout-btn" style="display: none;">Logout</button>
        </div>
    </header>

    <main>
        <section id="auth-info" style="display: none;">
            <h2>Welcome <span id="username-display"></span>!</h2>
            <p>You are logged in.</p>
        </section>

        <section id="game-setup-section">
            <h2>Game Setup</h2>
            <div>
                <label for="num-rounds-select">Select Number of Rounds:</label>
                <select id="num-rounds-select">
                    <option value="5">5 Rounds</option>
                    <option value="10">10 Rounds</option>
                    <option value="20">20 Rounds (Ranked)</option>
                </select>
                <button id="start-game-btn" class="submit-btn">Start New Game</button>
            </div>
        </section>

        <section id="game-section" style="display: none;">
            <h2>Map Guessr Game</h2>
            <div id="game-info">
                <div id="round-count">Round: 1</div>
                <div id="total-score-display">Total Score: 0</div>
            </div>
            <div id="map-container"></div>
            <div class="buttons-container">
                <button id="guess-btn">Guess Location</button>
                <button id="next-round-btn" style="display: none;">Next Round</button>
            </div>
            <div id="score-display"></div>
            <div id="distance-display"></div>
        </section>

        <section id="leaderboard-section">
            <h2>Global Leaderboard (20-Round Highscores)</h2>
            <table id="global-leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <h3>Your 20-Round Highscore Rank:</h3>
            <p id="user-global-rank">Loading...</p>
        </section>

        <section id="account-section" style="display: none;">
            <h2>My Account</h2>
            <p>User ID: <span id="account-user-id"></span></p>
            <p>Email: <span id="account-user-email"></span></p>
            <p>Role: <span id="account-user-role"></span></p>
            <p>Your current score: <span id="account-user-score"></span></p>
        </section>
    </main>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // Replace with your actual Client ID from Transitspotter
        const REDIRECT_URI = window.location.origin + '/auth-callback';
        const AUTH_SERVER_BASE_URL = 'https://auth.transitspotter.com/external';

        let map;
        let marker;
        let randomLatLng;
        let totalScore = 0;
        let roundCount = 1;
        let isAuthenticated = false;
        let currentUserId = null; // To store the logged-in user's ID
        let currentUserName = ''; // To store the logged-in user's name
        let selectedRounds = 5; // Default value

        // Page elements
        const authInfoSection = document.getElementById('auth-info');
        const usernameDisplay = document.getElementById('username-display');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const myAccountBtn = document.getElementById('my-account-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const gameSection = document.getElementById('game-section');
        const accountSection = document.getElementById('account-section');
        const scoreDisplay = document.getElementById('score-display');
        const distanceDisplay = document.getElementById('distance-display');
        const guessBtn = document.getElementById('guess-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const roundCountDisplay = document.getElementById('round-count');
        const totalScoreDisplay = document.getElementById('total-score-display');
        const numRoundsSelect = document.getElementById('num-rounds-select');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameSetupSection = document.getElementById('game-setup-section');
        const leaderboardSection = document.getElementById('leaderboard-section');

        const pages = {
            'game-setup': gameSetupSection,
            'game': gameSection,
            'account': accountSection,
            'leaderboard': leaderboardSection,
        };
        let currentPage = 'game-setup';

        function showPage(pageId) {
            Object.values(pages).forEach(section => {
                if (section) section.style.display = 'none';
            });
            if (pages[pageId]) pages[pageId].style.display = 'block';
            // The leaderboard is now always visible on the page, regardless of other sections
            leaderboardSection.style.display = 'block';
            currentPage = pageId;
        }

        async function initMap() {
            if (map) map.remove(); // Remove existing map if any
            map = new maptilersdk.Map({
                container: 'map-container',
                style: maptilersdk.MapStyle.SATELLITE,
                center: [0, 0],
                zoom: 1,
            });

            map.on('click', (e) => {
                if (marker) marker.remove();
                marker = new maptilersdk.Marker({ color: "#FF0000" })
                    .setLngLat(e.lngLat)
                    .addTo(map);
            });
        }

        async function startNewRound() {
            scoreDisplay.textContent = '';
            distanceDisplay.textContent = '';
            guessBtn.style.display = 'inline-block';
            nextRoundBtn.style.display = 'none';
            if (marker) marker.remove();
            marker = null;

            // Fetch a new random city
            try {
                const token = localStorage.getItem('access_token');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                const response = await fetch('/api/cities', { headers });
                if (!response.ok) throw new Error('Failed to fetch city');
                const data = await response.json();
                const cityName = data.city;

                const geoResponse = await fetch(`/api/geocode?city=${encodeURIComponent(cityName)}`, { headers });
                if (!geoResponse.ok) throw new Error('Failed to geocode city');
                const geoData = await geoResponse.json();

                if (geoData.features && geoData.features.length > 0) {
                    const coords = geoData.features[0].geometry.coordinates;
                    randomLatLng = [coords[0], coords[1]]; // [lng, lat]
                    map.flyTo({ center: [0, 0], zoom: 1, speed: 0.8 }); // Reset map view for new guess
                } else {
                    console.error('No features found for geocoding:', cityName);
                    alert('Could not find location for city. Starting next round.');
                    // This might cause an infinite loop if many cities fail, consider a counter or skip
                    if (roundCount < selectedRounds) {
                        roundCount++;
                        roundCountDisplay.textContent = `Round: ${roundCount}`;
                        startNewRound();
                    } else {
                        endGame();
                    }
                }
            } catch (error) {
                console.error('Error starting new round:', error);
                alert('Error starting new round: ' + error.message + '. Please try again.');
                endGame(); // End game on error
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function calculateScore(distance) {
            const maxScore = 1000;
            const maxDistanceForScore = 2000; // km
            if (distance >= maxDistanceForScore) return 0;
            return Math.round(maxScore * (1 - (distance / maxDistanceForScore)));
        }

        function resetGame() {
            totalScore = 0;
            roundCount = 1;
            roundCountDisplay.textContent = `Round: ${roundCount}`;
            totalScoreDisplay.textContent = `Total Score: ${totalScore}`;
            scoreDisplay.textContent = '';
            distanceDisplay.textContent = '';
            guessBtn.style.display = 'inline-block';
            nextRoundBtn.style.display = 'none';
            if (marker) marker.remove();
            marker = null;
        }

        function endGame() {
            alert(`Game Over! Your final score is: ${totalScore}`);
            if (selectedRounds === 20) {
                submitGlobalHighscore(totalScore); // Submit 20-round score
            }
            showPage('game-setup'); // Go back to game setup
        }

        // Authentication functions
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let randomString = '';
            for (let i = 0; i < length; i++) {
                randomString += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return randomString;
        }

        function startOAuthFlow() {
            const state = generateRandomString(16);
            localStorage.setItem('oauth_state', state);
            const authUrl = `${AUTH_SERVER_BASE_URL}/oauth/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${state}`;
            window.location.href = authUrl;
        }

        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('oauth_state');

            if (!code || !state || state !== storedState) {
                alert('OAuth callback error: Invalid state or missing code.');
                return false;
            }

            try {
                const tokenResponse = await fetch(`${AUTH_SERVER_BASE_URL}/oauth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        client_id: CLIENT_ID,
                        redirect_uri: REDIRECT_URI,
                        code: code,
                    }),
                });

                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.json();
                    throw new Error(`Failed to get token: ${errorData.error_description || tokenResponse.statusText}`);
                }

                const tokenData = await tokenResponse.json();
                localStorage.setItem('access_token', tokenData.access_token);
                localStorage.setItem('refresh_token', tokenData.refresh_token); // Store refresh token if available
                localStorage.setItem('token_expiry', Date.now() + tokenData.expires_in * 1000);

                await fetchUserInfo();
                updateAuthUI();
                alert('Login successful!');
                return true;

            } catch (error) {
                console.error('OAuth callback error:', error);
                alert('Login failed: ' + error.message);
                return false;
            } finally {
                localStorage.removeItem('oauth_state');
            }
        }

        async function fetchUserInfo() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                currentUserId = null;
                currentUserName = '';
                return false;
            }
            try {
                const response = await fetch('/api/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.valid && userData.user) {
                        currentUserId = userData.user.id;
                        currentUserName = userData.user.name || userData.user.email; // Use name or email
                        usernameDisplay.textContent = currentUserName;
                        return true;
                    }
                }
            } catch (e) {
                console.error('Error fetching user info:', e);
            }
            currentUserId = null;
            currentUserName = '';
            return false;
        }

        async function ensureValidToken() {
            const token = localStorage.getItem('access_token');
            const expiry = localStorage.getItem('token_expiry');

            if (!token || !expiry || Date.now() >= expiry) {
                // Token expired or not present, try refreshing or require login
                const refreshToken = localStorage.getItem('refresh_token');
                if (refreshToken) {
                    try {
                        const refreshResponse = await fetch(`${AUTH_SERVER_BASE_URL}/oauth/token`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                grant_type: 'refresh_token',
                                client_id: CLIENT_ID,
                                refresh_token: refreshToken,
                            }),
                        });
                        if (refreshResponse.ok) {
                            const data = await refreshResponse.json();
                            localStorage.setItem('access_token', data.access_token);
                            localStorage.setItem('token_expiry', Date.now() + data.expires_in * 1000);
                            await fetchUserInfo();
                            return true;
                        } else {
                            console.error('Failed to refresh token:', await refreshResponse.json());
                            appLogout(); // Clear tokens if refresh fails
                            return false;
                        }
                    } catch (e) {
                        console.error('Error refreshing token:', e);
                        appLogout();
                        return false;
                    }
                }
                return false; // No refresh token or refresh failed
            }
            await fetchUserInfo(); // Fetch user info if token is still valid
            return true;
        }

        function appLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('token_expiry');
            isAuthenticated = false;
            currentUserId = null;
            currentUserName = '';
            updateAuthUI();
            alert('Logged out.');
            showPage('game-setup'); // Go back to game setup
        }

        function updateAuthUI() {
            if (isAuthenticated) {
                authInfoSection.style.display = 'block';
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                myAccountBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
            } else {
                authInfoSection.style.display = 'none';
                loginBtn.style.display = 'inline-block';
                registerBtn.style.display = 'inline-block';
                myAccountBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
            // Fetch and update leaderboard on auth change
            fetchGlobalLeaderboard();
        }

        // Functions for My Account section
        async function fetchAccountDetails() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            try {
                const userResponse = await fetch('/api/user', { headers: { 'Authorization': `Bearer ${token}` } });
                const scoreResponse = await fetch('/api/score', { headers: { 'Authorization': `Bearer ${token}` } });
                const roleResponse = await fetch('/api/user/role', { headers: { 'Authorization': `Bearer ${token}` } });
                const idResponse = await fetch('/api/user/id', { headers: { 'Authorization': `Bearer ${token}` } });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    document.getElementById('account-user-id').textContent = userData.user.id || 'N/A';
                    document.getElementById('account-user-email').textContent = userData.user.email || 'N/A';
                }
                if (scoreResponse.ok) {
                    const scoreData = await scoreResponse.json();
                    // The /api/score endpoint returns total score, not session score
                    document.getElementById('account-user-score').textContent = scoreData.score !== undefined ? scoreData.score : 'N/A';
                }
                if (roleResponse.ok) {
                    const roleData = await roleResponse.json();
                    document.getElementById('account-user-role').textContent = roleData.role || 'N/A';
                }
            } catch (error) {
                console.error('Error fetching account details:', error);
                alert('Failed to load account details.');
            }
        }


        // Global Leaderboard Functions

        async function submitGlobalHighscore(score) {
            if (!isAuthenticated || !currentUserId || !currentUserName) {
                console.warn("User not authenticated or ID/Name missing. Highscore not submitted.");
                return;
            }
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/api/score/20round', { // New backend endpoint
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        score: score,
                        userName: currentUserName,
                        gameRoundCount: 20 // Explicitly send round count
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('Highscore submitted successfully:', data);
                    fetchGlobalLeaderboard(); // Refresh leaderboard after submitting score
                } else {
                    console.error('Failed to submit highscore:', data.error);
                    alert('Failed to submit highscore: ' + (data.error || 'Unknown error'));
                }
            }
            catch (error) {
                console.error('Error submitting highscore:', error);
                alert('Error submitting highscore: ' + error.message);
            }
        }

        async function fetchGlobalLeaderboard() {
            const leaderboardTableBody = document.querySelector('#global-leaderboard-table tbody');
            const userGlobalRank = document.getElementById('user-global-rank');
            leaderboardTableBody.innerHTML = '<tr><td colspan="3">Loading leaderboard...</td></tr>';
            userGlobalRank.textContent = 'Loading...';

            try {
                const token = localStorage.getItem('access_token'); // Get the user's token
                let headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/leaderboard/global/20round', { // New backend endpoint
                    headers: headers
                });
                const data = await response.json();

                if (response.ok) {
                    leaderboardTableBody.innerHTML = '';
                    if (data.leaderboard && data.leaderboard.length > 0) {
                        // Display top 5
                        data.leaderboard.slice(0, 5).forEach((entry, index) => {
                            const row = leaderboardTableBody.insertRow();
                            row.insertCell(0).textContent = entry.rank;
                            row.insertCell(1).textContent = entry.name;
                            row.insertCell(2).textContent = entry.score;
                        });
                    } else {
                        leaderboardTableBody.innerHTML = '<tr><td colspan="3">No 20-round highscores yet.</td></tr>';
                    }

                    // Display user's global rank
                    if (data.userRank) {
                        userGlobalRank.textContent = `Rank: ${data.userRank.rank} (Score: ${data.userRank.score})`;
                    } else if (isAuthenticated) {
                        userGlobalRank.textContent = 'You have not completed a 20-round game yet.';
                    } else {
                        userGlobalRank.textContent = 'Login to see your rank.';
                    }
                } else {
                    console.error('Failed to fetch leaderboard:', data.error);
                    leaderboardTableBody.innerHTML = `<tr><td colspan="3">Error loading leaderboard: ${data.error || 'Unknown'}</td></tr>`;
                    userGlobalRank.textContent = `Error loading your rank: ${data.error || 'Unknown'}`;
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                leaderboardTableBody.innerHTML = `<tr><td colspan="3">Error loading leaderboard: ${error.message}</td></tr>`;
                userGlobalRank.textContent = `Error loading your rank: ${error.message}`;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await initMap(); // Initialize map once

            loginBtn.addEventListener('click', startOAuthFlow);
            registerBtn.addEventListener('click', startOAuthFlow);
            logoutBtn.addEventListener('click', appLogout);
            myAccountBtn.addEventListener('click', () => {
                if (currentPage === 'account') {
                    showPage('game-setup'); // Toggle back to game setup if already on account
                } else {
                    fetchAccountDetails();
                    showPage('account');
                }
            });

            numRoundsSelect.addEventListener('change', (event) => {
                selectedRounds = parseInt(event.target.value);
            });

            startGameBtn.addEventListener('click', () => {
                resetGame();
                showPage('game'); // Show game section
                startNewRound(); // Start the first round
            });

            guessBtn.addEventListener('click', () => {
                if (!marker || !randomLatLng) {
                    alert('Please click on the map to place your guess!');
                    return;
                }

                const guessedLatLng = marker.getLngLat();
                const distance = calculateDistance(
                    randomLatLng[1], randomLatLng[0],
                    guessedLatLng.lat, guessedLatLng.lng
                );
                const score = calculateScore(distance);

                totalScore += score;
                scoreDisplay.textContent = `Round Score: ${score}`;
                distanceDisplay.textContent = `Distance: ${distance.toFixed(2)} km`;
                totalScoreDisplay.textContent = `Total Score: ${totalScore}`;

                // Fly to the actual location
                map.flyTo({ center: randomLatLng, zoom: 6, speed: 0.8 });

                // Add a marker for the actual location
                new maptilersdk.Marker({ color: "#0000FF" })
                    .setLngLat(randomLatLng)
                    .addTo(map);

                guessBtn.style.display = 'none';
                nextRoundBtn.style.display = 'inline-block';
            });

            nextRoundBtn.addEventListener('click', () => {
                if (roundCount < selectedRounds) {
                    roundCount++;
                    roundCountDisplay.textContent = `Round: ${roundCount}`;
                    startNewRound();
                } else {
                    endGame();
                }
            });

            // Handle OAuth callback on page load
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') && urlParams.has('state')) {
                const success = await handleOAuthCallback();
                if (success) {
                    isAuthenticated = true;
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    isAuthenticated = false;
                }
            } else {
                isAuthenticated = await ensureValidToken();
            }
            updateAuthUI(); // Update UI based on auth status
            showPage('game-setup'); // Always start on game setup page
        });
    </script>
</body>
</html>
