<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Map Guessr</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptilersdk.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #0cc0df;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        h1 {
            color: #444;
            margin-top: 0;
            margin-right: 20px; /* Space between title and buttons */
        }
        .auth-section {
            display: flex;
            gap: 10px; /* Space between buttons/user info */
            align-items: center;
            flex-wrap: wrap;
        }
        .auth-section button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .auth-section #login-button {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        .auth-section #register-button {
            background-color: #008CBA; /* Blue */
            color: white;
        }
        .user-info {
            color: #444;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info #logout-button {
            background-color: #f44336; /* Red */
            color: white;
        }

        main {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        section {
            margin-bottom: 30px;
        }
        /* Make maps-container relative to position its children absolutely */
        .maps-container {
            position: relative;
            height: 600px; /* Fixed height for the container */
            width: 100%;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            margin-bottom: 20px;
        }
        .map-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #guess-map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #location-map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none; /* Hidden by default */
        }
        #game-info {
            background-color: #f2f2f2;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }
        #game-info p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }
        .buttons-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center; /* Center the buttons */
        }
        .buttons-container button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #eee;
        }
        .buttons-container button:hover:enabled {
            background-color: #ddd;
        }
        .buttons-container button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #result-screen {
            text-align: center;
            padding: 40px 20px;
            background-color: #e0f2f7;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }
        #result-screen h2 {
            color: #2196F3;
            margin-bottom: 20px;
        }
        #result-screen p {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #play-again-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        #play-again-btn:hover {
            background-color: #45a049;
        }

        /* Styles copied from map Guessr stuff for pins and score display */
        /* CSS to hide default MapTiler controls */
        .maptiler-ctrl-group,
        .maptiler-ctrl,
        .maplibregl-ctrl-group,
        .maplibregl-ctrl {
            display: none !important;
        }

        /* Style for the custom guess pin (Teardrop shape using SVG data URL) */
        .guess-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            /* SVG data URL for a simple red teardrop with a white circle */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%23e53e3e" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            /* Position the bottom-center (the tip) of the element at the pixel coordinates */
            transform: translate3d(-50%, -100%, 0);
            /* Use translate3d for potentially better performance */
            z-index: 101;
            /* Higher z-index to be above other map elements and the green pin */
            pointer-events: none;
            /* Make it unclickable once placed, so map underneath can be interacted with */
        }

        /* Style for the real location pin (green teardrop, same as guess-pin but green) */
        .real-location-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            /* SVG data URL for a simple green teardrop with a white circle */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%2328a745" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            /* Position the bottom-center (the tip) of the element at the pixel coordinates */
            transform: translate3d(-50%, -100%, 0);
            /* Use translate3d for potentially better performance */
            z-index: 102;
            /* Higher z-index to be above other map elements and the red pin */
            pointer-events: none;
            /* Make it unclickable once placed, so map underneath can be interacted with */
        }

        /* Styles for score display */
        #round-score-display, #total-score-display-fixed {
            position: fixed;
            padding: 10px 15px;
            background-color: black; /* Changed to solid black */
            color: white;
            font-size: 1.2em;
            border-radius: 5px;
            z-index: 1000; /* High z-index to be on top */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            border: 1px solid white; /* Added white border */
        }

        #round-score-display {
            bottom: 20px;
            left: 20px;
        }

        #total-score-display-fixed { /* Renamed to avoid conflict with existing total-score */
            bottom: 20px;
            right: 20px;
        }

        /* Login/Register Form Styles (kept for display but not used for direct input) */
        #auth-form {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            display: flex; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        #auth-form p {
            margin-bottom: 0;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>Map Guessr</h1>
        <div class="auth-section">
            <div id="auth-buttons">
                <button id="login-button">Login</button>
                <button id="register-button">Register</button>
            </div>
            <div id="user-display" class="user-info" style="display: none;">
                <span id="user-greeting"></span>
                <button id="logout-button">Logout</button>
            </div>
        </div>
    </header>
    <main>
        <section id="auth-form">
            <p>Please log in or register via Transitspotter to play the game.</p>
            <p>Click "Login" or "Register" above to proceed.</p>
            <p style="font-weight: bold; color: red;">Note: Your domain must be approved by transitspotter administrators for authentication to work.</p>
            <p style="font-size: 0.8em; color: #888;">If you are not redirected after clicking login/register, check the console for errors.</p>
        </section>

        <section id="game-section" style="display: none;">
            <div id="game-info">
                <p id="round-count">Round: 1</p>
                <p>Total Score: <span id="total-score">0</span></p>
            </div>

            <div class="maps-container">
                <div id="guess-map" class="map-wrapper">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <p>Waiting for game to load...</p>
                    </div>
                </div>
                <div id="location-map" class="map-wrapper"></div>
            </div>

            <div class="buttons-container">
                <button id="new-location" disabled>New Location</button>
                <button id="submit-guess" disabled>Submit</button>
            </div>
        </section>

        <section id="result-screen">
            <h2>Game Over!</h2>
            <p>Your Final Score: <span id="final-score">0</span></p>
            <p>Distance from correct location: <span id="distance-info"></span></p>
            <button id="play-again-btn">Play Again</button>
        </section>
    </main>

    <footer>
        <p>Styles and HTML made by Natha | Map data and tiles by <a href="https://www.maptiler.com/" target="_blank" style="color: #fff; text-decoration: underline;">MapTiler</a></p>
    </footer>

    <div id="round-score-display"></div>
    <div id="total-score-display-fixed"></div>

    <script>
        // --- Maptiler Global Variables and Initialization (Existing Code from map Guessr stuff) ---
        let API_BASE_URL = 'https://mapguessr-worker.games-6cb.workers.dev';
        let API_TOKEN = ''; // This will be set by the OAuth flow

        let currentMarker = null;
        let userGuessLngLat = null;
        let guessPinElement = null;
        let currentLocationCoords = null;
        let mainMap = null; // Renamed from guessMap for clarity with two maps
        let overlayMap = null; // Renamed from locationMap for clarity with two maps
        let realLocationPinElement = null; // New for real location pin
        let totalScore = 0; // Initialized here, updated by game logic
        let roundCount = 1;
        const MAX_ROUNDS = 5; // Define the maximum number of rounds
        let mapsInitialized = false;
        let lineLayerVisible = false; // New for line drawing visibility

        const zoomLevel = 15;
        const initialCenter = [0, 0];
        const initialZoom = -1.0;

        // Style IDs for your custom MapTiler styles
        const MAIN_STYLE_ID = '0196cb69-f55f-71f8-9a8f-90fa083f0f67';
        const OVERLAY_STYLE_ID = '0196cb7f-9914-7a9b-aed1-8bfa7b9a0705';

        // --- OAuth 2.1 Configuration (from Login try) ---
        const OAUTH_AUTH_URL = 'https://auth.transitspotter.com/external/authorize';
        const OAUTH_TOKEN_URL = 'https://auth.transitspotter.com/external/token';
        const OAUTH_REVOKE_URL = 'https://auth.transitspotter.com/external/revoke';
        const OAUTH_USERINFO_URL = 'https://auth.transitspotter.com/external/introspect';

        // IMPORTANT: Replace 'mapguessr.com' with your actual registered domain
        const CLIENT_ID = 'mapguessr.com';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // --- DOM Elements (Combined and adjusted) ---
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const authButtonsDiv = document.getElementById('auth-buttons');
        const userDisplayDiv = document.getElementById('user-display');
        const userGreetingSpan = document.getElementById('user-greeting');
        const authForm = document.getElementById('auth-form'); // This is now just a message display

        const gameSection = document.getElementById('game-section');
        const resultScreen = document.getElementById('result-screen');
        const submitGuessBtn = document.getElementById('submit-guess');
        const newLocationBtn = document.getElementById('new-location');
        const playAgainBtn = document.getElementById('play-again-btn');

        const roundScoreDisplay = document.getElementById('round-score-display');
        const totalScoreDisplayFixed = document.getElementById('total-score-display-fixed'); // Renamed to avoid conflict

        // Game specific info display elements (from map Guessr stuff)
        const locationText = document.getElementById('location-text'); // This element doesn't exist in Login try. Added for compatibility.
        const guessedCoordsText = document.getElementById('guessed-coords'); // This element doesn't exist in Login try. Added for compatibility.
        const submitStatusText = document.getElementById('submit-status'); // This element doesn't exist in Login try. Added for compatibility.
        const pointsScoreText = document.getElementById('points-score'); // This element doesn't exist in Login try. Added for compatibility.
        const roundCountDisplay = document.getElementById('round-count'); // Existing in Login try, used in map Guessr stuff

        // Adjusted total score display for game info section (from Login try)
        const totalScoreDisplayGameInfo = document.getElementById('total-score'); // Existing in Login try.

        const finalScoreSpan = document.getElementById('final-score');
        const distanceInfoSpan = document.getElementById('distance-info'); // From Login try result screen

        // --- OAuth 2.1 Functions (from Login try) ---
        function getAccessToken() {
            return localStorage.getItem('access_token');
        }

        function getRefreshToken() {
            return localStorage.getItem('refresh_token');
        }

        function setTokens(accessToken, refreshToken) {
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);
        }

        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('expires_at');
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error parsing JWT:", e);
                return null;
            }
        }

        async function startOAuthFlow() {
            const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('oauth_state', state);

            const authUrl = `${OAUTH_AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=openid profile&state=${state}`;
            window.location.href = authUrl;
        }

        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('oauth_state');
            const error = urlParams.get('error');

            if (error) {
                console.error("OAuth error:", error, urlParams.get('error_description'));
                alert("Authentication failed: " + urlParams.get('error_description'));
                return;
            }

            if (!code || !state || state !== storedState) {
                console.error("OAuth callback invalid: Missing code or state mismatch.");
                return;
            }

            localStorage.removeItem('oauth_state');

            try {
                const response = await fetch(OAUTH_TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CLIENT_ID,
                        redirect_uri: REDIRECT_URI,
                        code: code
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token exchange failed: ${response.statusText}`);
                }

                const data = await response.json();
                setTokens(data.access_token, data.refresh_token);
                // Set the API_TOKEN for MapGuessr game logic
                API_TOKEN = data.access_token;
                const expiresIn = data.expires_in;
                const expiresAt = Date.now() + (expiresIn * 1000);
                localStorage.setItem('expires_at', expiresAt);

                await updateAuthUI();
                initializeGame(); // Initialize game after successful login
            } catch (error) {
                console.error("Error handling OAuth callback:", error);
                alert("Login failed. Please try again.");
                clearTokens();
                await updateAuthUI();
            }
        }

        async function fetchUserInfo() {
            const accessToken = getAccessToken();
            if (!accessToken) return null;

            try {
                const response = await fetch(OAUTH_USERINFO_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: new URLSearchParams({ token: accessToken }) // Use 'token' for introspect
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.active) { // Check 'active' status from introspection endpoint
                        const decodedToken = parseJwt(accessToken);
                        return decodedToken ? decodedToken.preferred_username || decodedToken.sub : 'User';
                    } else {
                        console.warn("Access token is not active.");
                        clearTokens();
                        return null;
                    }
                } else {
                    console.error("Failed to fetch user info:", response.status, response.statusText);
                    // If token is invalid or expired, clear it
                    if (response.status === 401 || response.status === 403) {
                        clearTokens();
                    }
                    return null;
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
                clearTokens();
                return null;
            }
        }

        async function updateAuthUI() {
            const username = await fetchUserInfo();
            if (username) {
                authButtonsDiv.style.display = 'none';
                userDisplayDiv.style.display = 'flex';
                userGreetingSpan.textContent = `Hello, ${username}!`;
                authForm.style.display = 'none'; // Hide login message
                gameSection.style.display = 'block'; // Show game section
                // Set the API_TOKEN for the game logic if user is logged in
                API_TOKEN = getAccessToken();
                if (API_TOKEN && !mapsInitialized) {
                    initializeGame(); // Initialize game if not already and user is logged in
                }
            } else {
                authButtonsDiv.style.display = 'flex';
                userDisplayDiv.style.display = 'none';
                userGreetingSpan.textContent = '';
                authForm.style.display = 'flex'; // Show login message
                gameSection.style.display = 'none'; // Hide game section
                resetGame(); // Reset game state if logged out
            }
        }

        async function logout() {
            const refreshToken = getRefreshToken();
            if (refreshToken) {
                try {
                    await fetch(OAUTH_REVOKE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            token: refreshToken,
                            token_type_hint: 'refresh_token',
                            client_id: CLIENT_ID
                        })
                    });
                    console.log("Refresh token revoked.");
                } catch (error) {
                    console.error("Error revoking refresh token:", error);
                }
            }
            clearTokens();
            API_TOKEN = ''; // Clear API token for game logic
            await updateAuthUI();
            alert("You have been logged out.");
            location.reload(); // Reload the page to ensure full reset
        }


        // --- Game Logic Functions (from map Guessr stuff, integrated) ---

        // Helper to remove markers and lines
        function clearMarkersAndLine() {
            if (currentMarker) {
                currentMarker.remove();
                currentMarker = null;
            }
            if (guessPinElement) {
                guessPinElement.remove();
                guessPinElement = null;
            }
            if (realLocationPinElement) {
                realLocationPinElement.remove();
                realLocationPinElement = null;
            }
            userGuessLngLat = null; // Clear previous guess

            if (mainMap && mainMap.getSource('line')) {
                mainMap.removeLayer('line-layer');
                mainMap.removeSource('line');
            }
            if (overlayMap && overlayMap.getSource('line')) {
                overlayMap.removeLayer('line-layer');
                overlayMap.removeSource('line');
            }
            lineLayerVisible = false;
        }

        async function loadMapStyles() {
            if (!API_TOKEN) {
                throw new Error('No API token available');
            }

            // Build style URLs using your API endpoints
            const customStyleUrl = `${API_BASE_URL}/api/mapstyle?style=${MAIN_STYLE_ID}&token=${API_TOKEN}`;
            const overlayStyleUrl = `${API_BASE_URL}/api/mapstyle?style=${OVERLAY_STYLE_ID}&token=${API_TOKEN}`;

            // Test that the style endpoints are accessible
            try {
                const mainStyleTest = await fetch(customStyleUrl);
                const overlayStyleTest = await fetch(overlayStyleUrl);

                if (!mainStyleTest.ok || !overlayStyleTest.ok) {
                    throw new Error('Cannot access map style APIs');
                }

                console.log('Map styles accessible via API');
                return { customStyleUrl, overlayStyleUrl };

            } catch (error) {
                console.error('Error testing map style APIs:', error);
                throw new Error('Map style APIs not accessible');
            }
        }

        async function initializeMaps() {
            if (mapsInitialized) return true; // Already initialized

            if (!API_TOKEN) {
                console.error("API token not set for map initialization.");
                return false;
            }

            let styleUrls;
            try {
                // No token status update needed here, handled by auth UI
                styleUrls = await loadMapStyles();
            } catch (error) {
                console.error('Failed to load map styles:', error);
                return false;
            }

            try {
                // Clear the placeholder content
                document.getElementById('guess-map').innerHTML = ''; // Adjusted ID
                document.getElementById('location-map').innerHTML = ''; // Adjusted ID

                // Configure MapTiler SDK to use your API as a source transform
                maptilersdk.config.apiKey = 'dummy'; // Required but not used since we're using custom URLs

                // Initialize the main map (guess map) with your API style URL
                mainMap = new maptilersdk.Map({
                    container: 'guess-map', // Adjusted ID
                    style: styleUrls.customStyleUrl,
                    center: initialCenter,
                    zoom: initialZoom,
                    interactive: true // User can interact to place guess
                });

                // Initialize the overlay map (location map) with your API style URL
                overlayMap = new maptilersdk.Map({
                    container: 'location-map', // Adjusted ID
                    style: styleUrls.overlayStyleUrl,
                    center: initialCenter,
                    zoom: initialZoom,
                    interactive: false // This map is just for display after guess
                });

                // Add navigation controls to the main map for better user experience
                mainMap.addControl(new maptilersdk.NavigationControl(), 'top-right');
                overlayMap.addControl(new maptilersdk.NavigationControl(), 'top-right');

                // Event listener for placing guess marker
                mainMap.on('click', handleMapClick);

                // Overlay map fullscreen toggle (from map Guessr stuff)
                overlayMap.getContainer().addEventListener('click', () => {
                    overlayMap.getContainer().classList.toggle('overlay-map-fullscreen');
                    mainMap.getContainer().classList.toggle('hidden-when-overlay-fullscreen'); // You might need CSS for this
                    // Adjust map size to re-render tiles correctly after class change
                    setTimeout(() => {
                        overlayMap.resize();
                        mainMap.resize();
                    }, 450); // Slightly more than transition duration
                });


                mapsInitialized = true;
                return true;
            } catch (error) {
                console.error('Error initializing maps:', error);
                alert('Failed to load maps. Please check your API token and network connection.');
                return false;
            }
        }

        async function findRandomCityAndSpot() {
            clearMarkersAndLine(); // Clear previous pins and line

            // Hide scores temporarily
            roundScoreDisplay.style.display = 'none';
            totalScoreDisplayFixed.style.display = 'none';
            resultScreen.style.display = 'none'; // Ensure result screen is hidden

            submitGuessBtn.disabled = true;
            newLocationBtn.disabled = true;

            // Show initial loading text for maps
            document.getElementById('guess-map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><p>Finding a new location...</p></div>';
            document.getElementById('location-map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><p>Finding a new location...</p></div>';


            try {
                // Fetch a random city from your worker API
                const response = await fetch(`${API_BASE_URL}/api/cities/random?token=${API_TOKEN}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                currentLocationCoords = [data.longitude, data.latitude];
                console.log('New location:', data.city, currentLocationCoords);

                // Update game info text (from map Guessr stuff)
                // locationText.textContent = `Guess the location! (${data.city})`; // Keep hidden for now
                // guessedCoordsText.textContent = 'Place your guess on the map.';
                // submitStatusText.textContent = 'Waiting for your guess.';
                // pointsScoreText.textContent = 'Points for this round: 0';

                // Reset guess map view to a default (e.g., world view)
                if (mainMap) {
                    mainMap.flyTo({ center: initialCenter, zoom: initialZoom, duration: 0 }); // Instant reset
                    document.getElementById('guess-map').innerHTML = ''; // Clear placeholder
                } else {
                     // Re-initialize if map was somehow not set up
                    await initializeMaps();
                    document.getElementById('guess-map').innerHTML = ''; // Clear placeholder
                }


                // Hide the location map initially
                document.getElementById('location-map').style.display = 'none';


                // Enable submission and new location buttons after a new location is found
                submitGuessBtn.disabled = false;
                newLocationBtn.disabled = false;

            } catch (error) {
                console.error('Error finding random city:', error);
                // Update game info text on error
                // locationText.textContent = 'Failed to load new location.';
                // submitStatusText.textContent = 'Error loading game. Check token/network.';
                alert('Could not load a new location. Please ensure your API token is valid and the worker is accessible.');
            }
        }


        function handleMapClick(e) {
            userGuessLngLat = [e.lngLat.lng, e.lngLat.lat];
            console.log('User guessed:', userGuessLngLat);

            // Remove existing guess pin if any
            if (guessPinElement) {
                guessPinElement.remove();
            }

            // Create a custom DOM element for the guess pin
            guessPinElement = document.createElement('div');
            guessPinElement.className = 'guess-pin';

            // Add the new guess pin to the main map
            currentMarker = new maptilersdk.Marker({
                element: guessPinElement,
                anchor: 'bottom'
            }).setLngLat(userGuessLngLat)
                .addTo(mainMap);

            // Update info text
            // guessedCoordsText.textContent = `Guessed: ${userGuessLngLat[0].toFixed(3)}, ${userGuessLngLat[1].toFixed(3)}`;
            submitGuessBtn.disabled = false; // Enable submit button
        }

        // Haversine formula to calculate distance between two lat-lng points on Earth
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in kilometers
        }

        function calculateScore(distanceKm) {
            // Scoring logic: 10000 points for < 1km, decreasing exponentially
            if (distanceKm < 1) {
                return 10000;
            } else if (distanceKm < 10) {
                return Math.round(10000 - (distanceKm * 500)); // Less steep drop for very close
            } else {
                // Exponential decay, adjust constants as needed
                return Math.max(0, Math.round(5000 * Math.exp(-distanceKm / 500)));
            }
        }

        function showRoundScore(score, distanceKm) {
            roundScoreDisplay.textContent = `Round Score: ${score} points (${distanceKm.toFixed(2)} km away)`;
            roundScoreDisplay.style.display = 'block';
            setTimeout(() => {
                roundScoreDisplay.style.opacity = '1';
            }, 10); // Trigger transition

            totalScoreDisplayFixed.textContent = `Total Score: ${totalScore} points`;
            totalScoreDisplayFixed.style.display = 'block';
            setTimeout(() => {
                totalScoreDisplayFixed.style.opacity = '1';
            }, 10); // Trigger transition
        }

        function showResults() {
            gameSection.style.display = 'none';
            authForm.style.display = 'none'; // Ensure auth form is hidden
            resultScreen.style.display = 'flex'; // Use flex to center content
            finalScoreSpan.textContent = totalScore;
            // distanceInfoSpan text content is set by the submit logic directly before this call.

            roundScoreDisplay.style.display = 'none';
            totalScoreDisplayFixed.style.display = 'none';
        }

        function resetGame() {
            totalScore = 0;
            roundCount = 1;
            roundCountDisplay.textContent = `Round: ${roundCount}`;
            totalScoreDisplayGameInfo.textContent = totalScore;

            clearMarkersAndLine(); // Clear markers and line
            submitGuessBtn.disabled = true;
            newLocationBtn.disabled = true;
            resultScreen.style.display = 'none';
            // locationText.textContent = 'Initialize maps to begin playing'; // Reset game info text
            // guessedCoordsText.textContent = 'The guessed coordinates will appear here';
            // submitStatusText.textContent = 'Game status will appear here';
            // pointsScoreText.textContent = 'Points will be calculated here';

            // Reset map views to initial state if they exist
            if (mainMap) {
                mainMap.flyTo({ center: initialCenter, zoom: initialZoom, duration: 0 });
                // Reset placeholder content
                document.getElementById('guess-map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><p>Waiting for game to load...</p></div>';
            }
            if (overlayMap) {
                overlayMap.flyTo({ center: initialCenter, zoom: initialZoom, duration: 0 });
                // Reset placeholder content
                document.getElementById('location-map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><p>Maps will load after initialization</p></div>';
            }
            // Hide the location map by default
            document.getElementById('location-map').style.display = 'none';
            mapsInitialized = false; // Allow re-initialization if needed
        }

        // Main game initialization function called after successful login
        async function initializeGame() {
            const mapsReady = await initializeMaps();
            if (mapsReady) {
                findRandomCityAndSpot();
                submitGuessBtn.disabled = false; // Enable buttons for game start
                newLocationBtn.disabled = false;
            } else {
                console.error("Game cannot start: Maps not initialized.");
                // Potentially display a more prominent error message to the user
            }
        }

        // --- Event Listeners (Combined and Adjusted) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if this is an OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                await handleOAuthCallback();
                // Clear the URL parameters after handling to avoid re-processing on refresh
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Always update UI based on current token status
            await updateAuthUI();

            loginButton.addEventListener('click', startOAuthFlow);
            registerButton.addEventListener('click', startOAuthFlow); // Both login/register initiate OAuth flow
            logoutButton.addEventListener('click', logout);

            // Game buttons event listeners (from map Guessr stuff)
            submitGuessBtn.addEventListener('click', () => {
                if (!userGuessLngLat || !currentLocationCoords) {
                    alert('Please place your guess on the map first!');
                    return;
                }

                // Show the location map
                document.getElementById('location-map').style.display = 'block';

                // Add the real location pin to the location map
                realLocationPinElement = document.createElement('div');
                realLocationPinElement.className = 'real-location-pin';
                new maptilersdk.Marker({
                    element: realLocationPinElement,
                    anchor: 'bottom'
                }).setLngLat(currentLocationCoords)
                    .addTo(overlayMap);

                // Add the guessed location pin to the location map as well
                const guessedLocationOnOverlayPin = document.createElement('div');
                guessedLocationOnOverlayPin.className = 'guess-pin'; // Use the same style for consistency
                new maptilersdk.Marker({
                    element: guessedLocationOnOverlayPin,
                    anchor: 'bottom'
                }).setLngLat(userGuessLngLat)
                    .addTo(overlayMap);


                // Calculate distance and score
                const distance = calculateDistance(
                    userGuessLngLat[1], userGuessLngLat[0],
                    currentLocationCoords[1], currentLocationCoords[0]
                );
                const roundScore = calculateScore(distance);
                totalScore += roundScore;

                // Update game info and score displays
                // submitStatusText.textContent = `You were ${distance.toFixed(2)} km away.`;
                // pointsScoreText.textContent = `Points: ${roundScore}`;
                roundCountDisplay.textContent = `Round: ${roundCount}`;
                totalScoreDisplayGameInfo.textContent = totalScore;
                distanceInfoSpan.textContent = `${distance.toFixed(2)} km`; // Update distance on result screen

                showRoundScore(roundScore, distance);

                // Draw line between guess and real location on both maps
                const lineGeojson = {
                    'type': 'FeatureCollection',
                    'features': [{
                        'type': 'Feature',
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [userGuessLngLat, currentLocationCoords]
                        }
                    }]
                };

                // Add line to mainMap
                if (mainMap.getSource('line')) {
                    mainMap.getSource('line').setData(lineGeojson);
                } else {
                    mainMap.addSource('line', {
                        'type': 'geojson',
                        'data': lineGeojson
                    });
                    mainMap.addLayer({
                        'id': 'line-layer',
                        'type': 'line',
                        'source': 'line',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#888',
                            'line-width': 4,
                            'line-dasharray': [2, 2]
                        }
                    });
                }
                lineLayerVisible = true;

                // Add line to overlayMap
                if (overlayMap.getSource('line')) {
                    overlayMap.getSource('line').setData(lineGeojson);
                } else {
                    overlayMap.addSource('line', {
                        'type': 'geojson',
                        'data': lineGeojson
                    });
                    overlayMap.addLayer({
                        'id': 'line-layer',
                        'type': 'line',
                        'source': 'line',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#888',
                            'line-width': 4,
                            'line-dasharray': [2, 2]
                        }
                    });
                }


                // Center the overlay map on the correct location and zoom in
                overlayMap.flyTo({ center: currentLocationCoords, zoom: zoomLevel, duration: 1000 });

                submitGuessBtn.disabled = true; // Disable submit after guess
                newLocationBtn.disabled = false; // Enable new location button for next round

                roundCount++;
                if (roundCount > MAX_ROUNDS) {
                    // Game Over
                    showResults();
                } else {
                    // Prepare for next round by enabling New Location button
                    // The next round is started by clicking "New Location" or "Play Again"
                }
            });

            newLocationBtn.addEventListener('click', () => {
                findRandomCityAndSpot(); // Start the next round
                submitGuessBtn.disabled = false; // Re-enable submit for new round
            });

            // Event listener for "Play Again" button on result screen
            playAgainBtn.addEventListener('click', () => {
                resetGame(); // Reset game state
                initializeGame(); // Start a new game with new maps
            });
        });
    </script>
</body>
</html>
