<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Map Guessr</title>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptilersdk.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: #333;
        }


        header {
            background-color: #0cc0df;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        header div {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        h1 {
            color: #444;
            margin-top: 0;
            margin-right: 20px; /* Space between title and buttons */
        }
        main {
            padding: 20px;
            max-width: 1900px;
            margin: 0 auto;
        }
        section {
            margin-bottom: 30px;
        }
        .maps-container {
            position: relative;
            height: 900px; /* Fixed height for the container */
            width: 100%;
            margin-bottom: 20px;
            overflow: hidden;
        }
        #maptiler-map {
            position: relative;
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            background-color: #eaeaea;
        }
        #overlay-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 150px;
            border: 2px solid #555;
            border-radius: 5px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            transition: all 0.4s ease-in-out;
        }
        #overlay-map:hover:not(.overlay-map-fullscreen) {
            width: 400px;
            height: 300px;
        }
        .overlay-map-fullscreen {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            /* Fill the entire maps-container */
            z-index: 100 !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important; /* Remove shadow when fullscreen */
        }
        .submit-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .submit-btn, .new-location-btn, .auth-btn {
            background-color: #0cc0df;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        .submit-btn:hover, .new-location-btn:hover, .auth-btn:hover {
            background-color: #0aa8c4;
        }
        .auth-btn {
            padding: 8px 15px;
            font-size: 1em;
            margin-left: 10px;
            background-color: #007bff; /* Default for login/account */
        }
        #register-btn {
            background-color: #28a745;
        }
        #logout-btn {
            background-color: #dc3545;
        }
        #my-account-btn {
            background-color: #6c757d; /* Grey for account button */
        }
        footer {
            background-color: #0cc0df;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 40px;
        }
        .maptiler-ctrl-group,
        .maptiler-ctrl,
        .maplibregl-ctrl-group,
        .maplibregl-ctrl {
            display: none !important;
        }
        .guess-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%23e53e3e" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform: translate3d(-50%, -100%, 0);
            z-index: 101;
            pointer-events: none;
        }
        .real-location-pin {
            position: absolute;
            width: 24px; /* Width of the pin */
            height: 36px; /* Height of the pin */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36"><path fill="%2328a745" d="M12,0C5.373,0,0,5.373,0,12c0,8.75,12,24,12,24s12-15.25,12-24C24,5.373,18.627,0,12,0z M12,17.5 c-3.033,0-5.5-2.467-5.5-5.5s2.467-5.5,5.5-5.5s5.5,2.467,5.5,5.5S15.033,17.5,12,17.5z"/><circle fill="white" cx="12" cy="12" r="4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform: translate3d(-50%, -100%, 0);
            z-index: 102;
            pointer-events: none;
        }
        #next-round-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 30px;
            font-size: 1.1em;
            background-color: #0cc0df;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 110; /* Ensure it's above the maps */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }
        #next-round-btn:hover {
            background-color: #0aa8c4;
        }
        #round-score-display, #total-score-display {
            position: fixed; /* Fixed position relative to viewport */
            padding: 10px 15px;
            background-color: black; /* Changed to solid black */
            color: white;
            font-size: 1.2em;
            border-radius: 5px;
            z-index: 1000; /* High z-index to be on top */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            border: 1px solid white; /* Added white border */
        }
        #round-score-display {
            bottom: 20px;
            left: 20px;
        }
        #total-score-display {
            bottom: 20px;
            right: 20px;
        }
        #account-page {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            display: none; /* Hidden by default */
        }
        #account-page h2 {
            color: #0cc0df;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        #account-page p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        #account-page strong {
            color: #555;
        }

        /* Leaderboard styles (from New imp) */
        .leaderboard-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .leaderboard-table th {
            background-color: #0cc0df;
            color: white;
            font-weight: bold;
        }
        .leaderboard-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .leaderboard-table tr:hover {
            background-color: #e9ecef;
        }
        .rank-1 { font-weight: bold; color: #ffd700; }
        .rank-2 { font-weight: bold; color: #c0c0c0; }
        .rank-3 { font-weight: bold; color: #cd7f32; }
        .leaderboard-status {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        .score-post-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .refresh-leaderboard-btn { /* From New imp */
            background-color: #0cc0df;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        .refresh-leaderboard-btn:hover { /* From New imp */
            background-color: #0aa8c4;
        }
        .refresh-leaderboard-btn:disabled { /* From New imp */
            background-color: #ccc;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    <header>
        <div>
            <h1>Map Guessr</h1>
            <p>May 15th 2025 - V9 (Score Calculation Fix)</p>
        </div>
        <div id="auth-container">
            <button id="login-btn" class="auth-btn">Login</button>
            <button id="register-btn" class="auth-btn">Register</button>
            <button id="my-account-btn" class="auth-btn" style="display:none;">My Account</button>
            <button id="logout-btn" class="auth-btn" style="display:none;">Logout</button>
            <span id="user-info" style="margin-left: 20px; color: #fff;"></span>
        </div>
    </header>
    <main style="display:none;">
        <section id="game-section">
            <h2>About</h2>
            <p>Game Rules.</p>
        </section>

        <section id="game-maps-section">
            <h2>Maps</h2>
            <div class="maps-container">
                <div id="maptiler-map"></div>
                <div id="overlay-map"></div>
            </div>
            <div class="submit-container">
                <button class="new-location-btn" id="new-location">New Location</button>
                <button class="submit-btn" id="submit-guess">Submit</button>
            </div>
        </section>

        <section id="game-answers-section">
            <h2>Game Answers</h2>
            <ul>
                <li id="location-text">The location label/place goes here/coordinates</li>
                <li id="guessed-coords">The guessed coordinates</li>
                <li id="submit-status">Submit button clicked? status goes here</li>
                <li id="points-score">Future points/scores system goes here</li>
                <li id="round-count">Round: 1</li>
                <li class="score-post-status" id="score-post-status">Score posting status will appear here</li>
            </ul>
        </section>

        <section>
            <div class="leaderboard-section">
                <div class="leaderboard-header">
                    <h3> Leaderboard</h3>
                    <button class="refresh-leaderboard-btn" id="refresh-leaderboard" disabled>Refresh</button>
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #666;">Login to load leaderboard</td>
                        </tr>
                    </tbody>
                </table>
                <div class="leaderboard-status" id="leaderboard-status">Leaderboard will load after login</div>
            </div>
        </section>
        <section id="account-page" style="display:none;">
            <h2>Account Information</h2>
            <p><strong>User ID:</strong> <span id="account-user-id">Not available</span></p>
            <p><strong>Client ID:</strong> <span id="account-client-id">Not available</span></p>
            <p><strong>Token Expiry:</strong> <span id="account-token-expiry">Not available</span></p>
            <p><strong>Token Issued At:</strong> <span id="account-token-iat">Not available</span></p>
            <p><strong>Token Type:</strong> <span id="account-token-type">Not available</span></p>
            <p><strong>Token Active:</strong> <span id="account-token-active">Not available</span></p>
        </section>
    </main>
    <footer>
        <p>Made by Nathann and Jason</p>
    </footer>


    <div id="round-score-display"></div>
    <div id="total-score-display"></div>


    <script>
        // --- OAuth Configuration ---
        const OAUTH_CLIENT_ID = 'mapguessr-github-io.pages.dev';
        const OAUTH_REDIRECT_URI = window.location.href.split('?')[0];
        const AUTH_SERVER_BASE_URL = 'https://auth.transitspotter.com';

        // --- Map Guessr Configuration ---
        const apiKey = 'ZS9RHHRim7f1OZRKuI6n'; // This is MapTiler SDK key
        maptilersdk.config.apiKey = apiKey;
        let API_BASE_URL = 'https://mapguessr-worker.games-6cb.workers.dev'; // Backend API for game data and leaderboard [cite: 534]

        let currentMarker = null;
        let userGuessLngLat = null;
        let guessPinElement = null;
        let currentLocationCoords = null;
        let totalScore = 0;
        let mainMap = null;
        let overlayMap = null;
        let realLocationPinElement = null;
        let roundCount = 1;
        const zoomLevel = 15;
        const customStyleUrl = 'https://api.maptiler.com/maps/0196cb69-f55f-71f8-9a8f-90fa083f0f67/style.json?key=' + apiKey;
        const overlayStyleUrl = 'https://api.maptiler.com/maps/0196cb7f-9914-7a9b-aed1-8bfa7b9a0705/style.json?key=' + apiKey;
        const initialCenter = [0, 0];
        const initialZoom = -1.0;
        let lineLayerVisible = false;

        // --- Application State ---
        let isAuthenticated = false;
        let currentPage = 'game'; // 'game' or 'account'
        let userScore = null; // Store current user score info [cite: 534]

        // --- OAuth Helper Functions ---
        async function generateCodeVerifierAndChallenge() {
            const codeVerifier = generateRandomString(64);
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
            return { codeVerifier, codeChallenge };
        }


        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const randomValues = new Uint8Array(length);
            crypto.getRandomValues(randomValues);
            for (let i = 0; i < length; i++) {
                result += charset[randomValues[i] % charset.length];
            }
            return result;
        }


        async function startOAuthFlow() {
            const { codeVerifier, codeChallenge } = await generateCodeVerifierAndChallenge();
            const state = generateRandomString(32);
            sessionStorage.setItem('code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);


            const authUrl = new URL(`${AUTH_SERVER_BASE_URL}/external/authorize`);
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('client_id', OAUTH_CLIENT_ID);
            authUrl.searchParams.append('redirect_uri', OAUTH_REDIRECT_URI);
            authUrl.searchParams.append('code_challenge', codeChallenge);
            authUrl.searchParams.append('code_challenge_method', 'S256');
            authUrl.searchParams.append('state', state);
            window.location.href = authUrl.toString();
        }


        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            if (error) {
                console.error('OAuth error:', error, urlParams.get('error_description'));
                showMessageBox(`OAuth Error: ${error} - ${urlParams.get('error_description') || 'Unknown error'}`);
                return false;
            }


            const storedState = sessionStorage.getItem('oauth_state');
            if (!state || state !== storedState) {
                console.error('Invalid state parameter');
                showMessageBox('Error: Invalid state. CSRF attack suspected.');
                return false;
            }


            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error('Code verifier not found');
                showMessageBox('Error: Code verifier missing. Please try logging in again.');
                return false;
            }


            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: OAUTH_CLIENT_ID,
                        redirect_uri: OAUTH_REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });
                const tokenData = await response.json();


                if (tokenData.error) {
                    console.error('Token error:', tokenData.error, tokenData.error_description);
                    showMessageBox(`Token Error: ${tokenData.error} - ${tokenData.error_description || 'Failed to get token'}`);
                    return false;
                }
                localStorage.setItem('access_token', tokenData.access_token);
                localStorage.setItem('refresh_token', tokenData.refresh_token);
                localStorage.setItem('token_expiry', Date.now() + (tokenData.expires_in * 1000));
                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');
                return true;
            } catch (err) {
                console.error('Token exchange error:', err);
                showMessageBox('Error exchanging code for token. Please check console.');
                return false;
            }
        }


        async function refreshToken() {
            const refreshTokenVal = localStorage.getItem('refresh_token');
            if (!refreshTokenVal) return false;
            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        grant_type: 'refresh_token',
                        refresh_token: refreshTokenVal,
                        client_id: OAUTH_CLIENT_ID
                    })
                });
                const tokenData = await response.json();


                if (tokenData.error) {
                    console.error('Refresh error:', tokenData.error, tokenData.error_description);
                    localStorage.clear();
                    return false;
                }
                localStorage.setItem('access_token', tokenData.access_token);
                if (tokenData.refresh_token) {
                    localStorage.setItem('refresh_token', tokenData.refresh_token);
                }
                localStorage.setItem('token_expiry', Date.now() + (tokenData.expires_in * 1000));
                return true;
            } catch (error) {
                console.error('Token refresh error:', error);
                return false;
            }
        }


        async function ensureValidToken() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) return false;
            const expiryTime = parseInt(localStorage.getItem('token_expiry'), 10);
            if (isNaN(expiryTime)) {
                localStorage.clear();
                return false;
            }
            if (Date.now() > expiryTime - 60000) { // Refresh if expiring in the next minute
                console.log("Token expired or expiring soon, attempting refresh...");
                return await refreshToken();
            }
            return true;
        }


        async function appLogout() {
            const refreshTokenVal = localStorage.getItem('refresh_token');
            if (refreshTokenVal) {
                try {
                    await fetch(`${AUTH_SERVER_BASE_URL}/external/revoke`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Origin': window.location.origin
                        },
                        body: JSON.stringify({
                            token: refreshTokenVal,
                            token_type_hint: 'refresh_token'
                        })
                    });
                } catch (error) {
                    console.error('Error revoking token:', error);
                }
            }
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('token_expiry');
            isAuthenticated = false;
            resetGameAndUI();
            updateAuthUI();
            currentPage = 'game'; // Reset to game page on logout
            showPage(currentPage);
        }

        function resetGameAndUI() {
            // Remove map instances if they exist
            if (mainMap) {
                mainMap.remove();
                mainMap = null;
            }
            if (overlayMap) {
                overlayMap.remove();
                overlayMap = null;
            }

            // Clear markers and pins
            if (currentMarker) {
                currentMarker.remove();
                currentMarker = null;
            }
            if (guessPinElement) {
                guessPinElement.remove();
                guessPinElement = null;
            }
            if (realLocationPinElement) {
                realLocationPinElement.remove();
                realLocationPinElement = null;
            }
            // Reset game state variables
            userGuessLngLat = null;
            currentLocationCoords = null;
            totalScore = 0;
            roundCount = 1;
            lineLayerVisible = false; // Assuming this should be reset

            // Reset UI text elements
            document.getElementById('location-text').textContent = 'The location label/place goes here/coordinates';
            document.getElementById('guessed-coords').textContent = 'The guessed coordinates...';
            document.getElementById('submit-status').textContent = 'Submit button clicked? status goes here';
            document.getElementById('points-score').textContent = 'Future points/scores system goes here';
            document.getElementById('round-count').textContent = 'Round: 1';
            document.getElementById('score-post-status').textContent = 'Score posting status will appear here'; // Added this line

            // Disable game buttons
            document.getElementById('new-location').disabled = true;
            document.getElementById('submit-guess').disabled = true;

            // Reset leaderboard display
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; color: #666;">Login to load leaderboard</td>
                </tr>
            `;
            document.getElementById('leaderboard-status').textContent = 'Leaderboard will load after login';
            document.getElementById('refresh-leaderboard').disabled = true;
        }

        // --- UI Update Functions ---
        function showPage(pageId) {
            document.querySelectorAll('main section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(pageId + '-page').style.display = 'block';

            if (pageId === 'game') {
                document.getElementById('game-section').style.display = 'block';
                document.getElementById('game-maps-section').style.display = 'block';
                document.getElementById('game-answers-section').style.display = 'block';
                document.querySelector('.leaderboard-section').parentElement.style.display = 'block'; // Show the leaderboard section
            } else if (pageId === 'account') {
                // Ensure account page is displayed
                document.getElementById('account-page').style.display = 'block';
                updateAccountInfo();
            }
        }


        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const myAccountBtn = document.getElementById('my-account-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfoSpan = document.getElementById('user-info');
            const mainContent = document.querySelector('main');

            if (isAuthenticated) {
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                myAccountBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
                mainContent.style.display = 'block'; // Show main content
                userInfoSpan.textContent = `Logged in as: ${localStorage.getItem('user_id') || 'User'}`; // Display user ID
                fetchLeaderboard(); // Fetch leaderboard on successful login/authentication
                document.getElementById('refresh-leaderboard').disabled = false; // Enable refresh button
                document.getElementById('new-location').disabled = false; // Enable game buttons
                document.getElementById('submit-guess').disabled = false;
            } else {
                loginBtn.style.display = 'inline-block';
                registerBtn.style.display = 'inline-block';
                myAccountBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
                mainContent.style.display = 'none'; // Hide main content
                userInfoSpan.textContent = '';
                resetGameAndUI(); // Reset game state and UI on logout
            }
        }


        async function updateAccountInfo() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                document.getElementById('account-user-id').textContent = 'Not logged in';
                document.getElementById('account-client-id').textContent = 'Not logged in';
                document.getElementById('account-token-expiry').textContent = 'Not logged in';
                document.getElementById('account-token-iat').textContent = 'Not logged in';
                document.getElementById('account-token-type').textContent = 'Not logged in';
                document.getElementById('account-token-active').textContent = 'Not logged in';
                return;
            }


            try {
                const response = await fetch(`${AUTH_SERVER_BASE_URL}/external/introspect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({ token: accessToken })
                });
                const data = await response.json();


                if (data.active) {
                    document.getElementById('account-user-id').textContent = data.sub || 'N/A';
                    localStorage.setItem('user_id', data.sub || 'User'); // Store user ID
                    document.getElementById('account-client-id').textContent = data.client_id || 'N/A';
                    document.getElementById('account-token-expiry').textContent = data.exp ? new Date(data.exp * 1000).toLocaleString() : 'N/A';
                    document.getElementById('account-token-iat').textContent = data.iat ? new Date(data.iat * 1000).toLocaleString() : 'N/A';
                    document.getElementById('account-token-type').textContent = data.token_type || 'N/A';
                    document.getElementById('account-token-active').textContent = 'Yes';
                } else {
                    document.getElementById('account-user-id').textContent = 'Inactive or invalid token';
                    document.getElementById('account-client-id').textContent = 'Inactive or invalid token';
                    document.getElementById('account-token-expiry').textContent = 'Inactive or invalid token';
                    document.getElementById('account-token-iat').textContent = 'Inactive or invalid token';
                    document.getElementById('account-token-type').textContent = 'Inactive or invalid token';
                    document.getElementById('account-token-active').textContent = 'No';
                }
            } catch (error) {
                console.error('Error fetching account info:', error);
                document.getElementById('account-user-id').textContent = 'Error loading info';
                document.getElementById('account-client-id').textContent = 'Error loading info';
                document.getElementById('account-token-expiry').textContent = 'Error loading info';
                document.getElementById('account-token-iat').textContent = 'Error loading info';
                document.getElementById('account-token-type').textContent = 'Error loading info';
                document.getElementById('account-token-active').textContent = 'Error loading info';
            }
        }

        // --- Custom Message Box ---
        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                font-family: Arial, sans-serif;
                text-align: center;
                max-width: 400px;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button style="
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-top: 15px;
                ">Dismiss</button>
            `;
            document.body.appendChild(messageBox);
            messageBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }


        // --- Map Initialization ---
        async function initializeMaps() {
            try {
                // Main map setup
                mainMap = new maptilersdk.Map({
                    container: 'maptiler-map',
                    style: customStyleUrl, // Use the custom style URL
                    center: initialCenter,
                    zoom: initialZoom
                });

                // Overlay map setup
                overlayMap = new maptilersdk.Map({
                    container: 'overlay-map',
                    style: overlayStyleUrl, // Use the custom style URL
                    center: initialCenter,
                    zoom: initialZoom,
                    interactive: false // Overlay map is not interactive
                });

                // Event listener for main map click to place guess pin
                mainMap.on('click', (e) => {
                    userGuessLngLat = e.lngLat;
                    if (guessPinElement) {
                        guessPinElement.remove();
                    }
                    guessPinElement = new maptilersdk.Marker({
                        element: createPinElement('guess-pin')
                    })
                        .setLngLat(userGuessLngLat)
                        .addTo(mainMap);
                    document.getElementById('guessed-coords').textContent = `Guessed: ${userGuessLngLat.lat.toFixed(4)}, ${userGuessLngLat.lng.toFixed(4)}`;
                    document.getElementById('submit-guess').disabled = false;
                });

                // Fullscreen toggle for overlay map
                document.getElementById('overlay-map').addEventListener('click', () => {
                    const overlay = document.getElementById('overlay-map');
                    overlay.classList.toggle('overlay-map-fullscreen');
                    overlayMap.resize(); // Re-render map after size change
                });

                mapsInitialized = true;
                // Enable game buttons after maps are initialized
                document.getElementById('new-location').disabled = false;

                // Start the first round
                findRandomCityAndSpot();

            } catch (error) {
                console.error("Error initializing maps:", error);
                showMessageBox(`Failed to initialize maps: ${error.message}. Please check your token and try again.`);
                // Disable game buttons if maps fail to initialize
                document.getElementById('new-location').disabled = true;
                document.getElementById('submit-guess').disabled = true;
            }
        }

        function createPinElement(className) {
            const el = document.createElement('div');
            el.className = className;
            return el;
        }

        // --- Game Logic Functions ---
        async function findRandomCityAndSpot() {
            document.getElementById('submit-status').textContent = 'Finding new location...';
            document.getElementById('new-location').disabled = true;
            document.getElementById('submit-guess').disabled = true;

            // Clear previous markers
            if (currentMarker) {
                currentMarker.remove();
                currentMarker = null;
            }
            if (guessPinElement) {
                guessPinElement.remove();
                guessPinElement = null;
            }
            if (realLocationPinElement) {
                realLocationPinElement.remove();
                realLocationPinElement = null;
            }
            // Clear the line layer if it exists
            if (mainMap.getLayer('line-layer')) {
                mainMap.removeLayer('line-layer');
                mainMap.removeSource('line-source');
                lineLayerVisible = false;
            }


            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    showMessageBox("You must be logged in to find a new location.");
                    return;
                }
                const response = await fetch(`${API_BASE_URL}/api/random-city?token=${accessToken}`); // Use API_BASE_URL
                if (!response.ok) {
                    throw new Error(`HTTP error fetching random city: ${response.status}`);
                }
                const data = await response.json();
                currentLocationCoords = { lng: data.coordinates[0], lat: data.coordinates[1] };
                document.getElementById('location-text').textContent = `Location: ${data.city_name}, ${data.country_name} (${currentLocationCoords.lat.toFixed(4)}, ${currentLocationCoords.lng.toFixed(4)})`;

                // Set initial map view to the new location (but hide it from the user)
                mainMap.setCenter(currentLocationCoords);
                mainMap.setZoom(zoomLevel);

                overlayMap.setCenter(currentLocationCoords);
                overlayMap.setZoom(zoomLevel);

                // Add the actual location marker (initially hidden)
                realLocationPinElement = new maptilersdk.Marker({
                    element: createPinElement('real-location-pin')
                })
                    .setLngLat(currentLocationCoords)
                    .addTo(mainMap);
                realLocationPinElement.getElement().style.display = 'none'; // Hide initially

                document.getElementById('submit-status').textContent = 'Place your guess on the map!';
                document.getElementById('new-location').disabled = false;

            } catch (error) {
                console.error("Error finding random city:", error);
                showMessageBox(`Error finding random city: ${error.message}. Please try again later.`);
                document.getElementById('new-location').disabled = false; // Re-enable to allow retry
            }
        }


        function calculateScore(guessCoords, actualCoords) {
            const R = 6371e3; // metres
            const 1 = guessCoords.lat * Math.PI / 180; // , 位 in radians
            const 2 = actualCoords.lat * Math.PI / 180;
            const  = (actualCoords.lat - guessCoords.lat) * Math.PI / 180;
            const 位 = (actualCoords.lng - guessCoords.lng) * Math.PI / 180;

            const a = Math.sin( / 2) * Math.sin( / 2) +
                Math.cos(1) * Math.cos(2) *
                Math.sin(位 / 2) * Math.sin(位 / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // in metres

            // Scoring system:
            // 0-10km: 1000 points
            // 10-50km: 900-800 points
            // 50-100km: 800-600 points
            // 100-500km: 600-300 points
            // 500-1000km: 300-100 points
            // >1000km: 100 points down to 0 at 5000km
            let score;
            const km = distance / 1000;

            if (km <= 10) {
                score = 1000;
            } else if (km <= 50) {
                score = 900 - (km - 10) * (100 / 40);
            } else if (km <= 100) {
                score = 800 - (km - 50) * (200 / 50);
            } else if (km <= 500) {
                score = 600 - (km - 100) * (300 / 400);
            } else if (km <= 1000) {
                score = 300 - (km - 500) * (200 / 500);
            } else if (km <= 5000) {
                score = 100 - (km - 1000) * (100 / 4000);
            } else {
                score = 0;
            }

            return { score: Math.max(0, Math.round(score)), distance: distance };
        }

        // --- Leaderboard Functions (from New imp) ---
        async function postScore(score) {
            const scorePostStatusElement = document.getElementById('score-post-status');
            const accessToken = localStorage.getItem('access_token');

            if (!accessToken) {
                scorePostStatusElement.textContent = 'Login to post your score!';
                scorePostStatusElement.style.color = '#dc3545';
                return;
            }

            scorePostStatusElement.textContent = 'Posting score...';
            scorePostStatusElement.style.color = '#666';

            try {
                const response = await fetch(`${API_BASE_URL}/api/score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ score: score })
                });

                if (response.ok) {
                    const data = await response.json();
                    userScore = data.user_score; // Update userScore
                    scorePostStatusElement.textContent = `Score posted! Your best: ${userScore.score} points (${userScore.distance_km.toFixed(2)} km)`;
                    scorePostStatusElement.style.color = '#28a745';
                    fetchLeaderboard(); // Refresh leaderboard after posting score
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error: ${response.status}`);
                }
            } catch (error) {
                console.error('Error posting score:', error);
                scorePostStatusElement.textContent = `Error posting score: ${error.message}`;
                scorePostStatusElement.style.color = '#dc3545';
            }
        }
        
        async function fetchLeaderboard() {
            const statusElement = document.getElementById('leaderboard-status');
            const tbody = document.getElementById('leaderboard-body');
            const refreshButton = document.getElementById('refresh-leaderboard');
            refreshButton.disabled = true; // Disable refresh button while loading

            try {
                statusElement.textContent = 'Loading leaderboard...';
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    statusElement.textContent = 'Login to load leaderboard';
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #666;">Login to load leaderboard</td></tr>`;
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/leaderboard?token=${accessToken}`); // Pass token [cite: 548]
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const data = await response.json();
                displayLeaderboard(data.leaderboard); [cite: 549]
                statusElement.textContent = `Last updated: ${new Date().toLocaleTimeString()}`; [cite: 550]
            } catch (error) {
                console.error('Error fetching leaderboard:', error); [cite: 550]
                statusElement.textContent = `Error loading leaderboard: ${error.message}`; [cite: 550]
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #dc3545;"> Failed to load leaderboard </td></tr>`; [cite: 551, 552]
            } finally {
                refreshButton.disabled = false; // Re-enable refresh button
            }
        }

        function displayLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboard-body'); [cite: 553]
            tbody.innerHTML = ''; // Clear existing rows

            if (!leaderboard || leaderboard.length === 0) { [cite: 554]
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #666;">No players on the leaderboard yet. Be the first!</td></tr>`;
                return;
            }

            leaderboard.forEach((entry, index) => {
                const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${rankClass}">${index + 1}</td>
                    <td>${entry.player_name || 'Anonymous'}</td>
                    <td>${entry.score} (${(entry.distance_km || 0).toFixed(2)} km)</td>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }
        // End Leaderboard Functions

        // Helper function for showing status messages (adapted from New imp's updateTokenStatus)
        function updateStatusMessage(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-message ${status}`; // Add a generic class for styling
                element.textContent = message;
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('login-btn').addEventListener('click', startOAuthFlow);
            document.getElementById('register-btn').addEventListener('click', startOAuthFlow);
            document.getElementById('logout-btn').addEventListener('click', appLogout);
            document.getElementById('my-account-btn').addEventListener('click', () => {
                showPage(currentPage === 'account' ? 'game' : 'account');
            });
            document.getElementById('new-location').addEventListener('click', findRandomCityAndSpot);
            document.getElementById('refresh-leaderboard').addEventListener('click', fetchLeaderboard); // Hook up refresh button

            // Handle map click for placing guess (already in map Guessr stuff, ensure logic is correct)
            // This needs to be moved inside initializeMaps or handled carefully after maps are loaded
            // mainMap.on('click', (e) => { ... }); // This is already handled inside initializeMaps now.


            document.getElementById('submit-guess').addEventListener('click', async () => {
                if (!userGuessLngLat || !currentLocationCoords) {
                    document.getElementById('submit-status').textContent = 'Please place a guess on the map first and ensure a location is loaded!';
                    return;
                }

                const scoreResult = calculateScore(userGuessLngLat, currentLocationCoords);

                if (isNaN(scoreResult.score) || isNaN(scoreResult.distance)) {
                    console.error("Score calculation returned NaN.", scoreResult);
                    document.getElementById('submit-status').textContent = 'Error: Score calculation failed.';
                    return;
                }

                totalScore += scoreResult.score;

                document.getElementById('points-score').textContent =
                    `Round Score: ${scoreResult.score} points (${(scoreResult.distance / 1000).toFixed(2)} km) | Total Score: ${totalScore} points`;

                document.getElementById('submit-status').textContent = `Guess submitted! You were ${(scoreResult.distance / 1000).toFixed(2)} km away.`;

                if (currentMarker && currentMarker.getElement()) {
                    currentMarker.getElement().style.display = 'block'; // This was `currentMarker` in `New imp`
                    console.log("Showing actual location marker on main map.");
                } else {
                    console.warn("Could not find currentMarker element to show.");
                }

                // Show line between guess and actual location
                if (mainMap.getSource('line-source')) {
                    mainMap.removeLayer('line-layer');
                    mainMap.removeSource('line-source');
                }

                mainMap.addSource('line-source', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': [
                                [userGuessLngLat.lng, userGuessLngLat.lat],
                                [currentLocationCoords.lng, currentLocationCoords.lat]
                            ]
                        }
                    }
                });
                mainMap.addLayer({
                    'id': 'line-layer',
                    'type': 'line',
                    'source': 'line-source',
                    'layout': {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': '#888',
                        'line-width': 4
                    }
                });
                lineLayerVisible = true;


                // Post score to leaderboard
                if (scoreResult.score > 0) {
                    await postScore(scoreResult.score); // Call the postScore function
                }

                roundCount++;
                document.getElementById('round-count').textContent = `Round: ${roundCount}`;

                setTimeout(() => {
                    console.log("Starting next round...");
                    findRandomCityAndSpot();
                }, 5000);
            });

            // Handle OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') && urlParams.has('state')) {
                const success = await handleOAuthCallback();
                if (success) {
                    isAuthenticated = true;
                    // Clean URL - remove OAuth parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    isAuthenticated = false;
                    // Error already alerted in handleOAuthCallback
                }
            } else {
                // Regular page load, check if already logged in via stored token
                isAuthenticated = await ensureValidToken();
            }
            updateAuthUI(); // This will show/hide game content and init if authenticated

            // Initialize maps only if authenticated
            if (isAuthenticated && !mapsInitialized) {
                initializeMaps();
            }
        });
    </script>
</body>
</html>
